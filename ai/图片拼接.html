<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>å›¾ç‰‡æ‹¼æ¥</title>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      background: #f8fafc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans', sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content {
      flex: 1;
      padding: 16px;
      padding-top: 24px; /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å…å†…å®¹ç´§è´´é¡¶éƒ¨ */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .preview-container {
      background: #e0e7ff;
      border: 2px solid #4f46e5;
      border-radius: 8px;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      max-height: 60vh;
      min-height: 200px;
      width: 100%;
      margin: 0 auto;
    }

    .preview-container.horizontal {
      aspect-ratio: 16/9;
    }

    .preview-container.vertical {
      aspect-ratio: 9/16;
      display: flex;
      justify-content: center;
    }

    .preview-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .preview-placeholder {
      color: #818cf8;
      font-size: 48px;
      text-align: center;
      width: 100%;
    }

    .image-strip {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding-bottom: 8px;
      scrollbar-width: none;
    }

    .image-strip::-webkit-scrollbar {
      display: none;
    }

    .image-card {
      flex: 0 0 auto;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .image-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-card .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .image-card:hover .overlay {
      opacity: 1;
    }

    .overlay-btn {
      color: white;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 2px;
      cursor: pointer;
    }

    .add-card {
      background: #e0e7ff;
      color: #4f46e5;
      font-size: 32px;
      cursor: pointer;
    }

    .btn {
      height: 40px;
      padding: 0 24px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .action-bar {
      height: 64px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 16px;
    }

    .direction-btn {
      flex: 1;
      margin: 0 4px;
      background: #e0e7ff;
      color: #4f46e5;
    }

    .direction-btn.selected {
      background: #4f46e5;
      color: white;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="card">
      <div class="preview-container horizontal" id="stitchPreview">
        <div class="preview-placeholder">ğŸ–¼ï¸</div>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:12px;color: #64748b">é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</div>
      <div class="image-strip" id="imageStrip"></div>
      <input type="file" id="imageInput" hidden accept="image/*" multiple />
    </div>

    <div class="card">
      <div style="margin-bottom:12px;color: #64748b">æ‹¼æ¥æ–¹å‘</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px">
        <button class="btn direction-btn selected" data-direction="horizontal">æ¨ªå‘</button>
        <button class="btn direction-btn" data-direction="vertical">ç«–å‘</button>
      </div>
      <button class="btn" id="stitchBtn" style="width:100%">
        <svg viewBox="0 0 24 24" style="width: 20px;height: 20px;fill: white">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 9h10V7H7v2zm5 8h-2v-4H7v-2h6v6z"/>
        </svg>
        å¼€å§‹æ‹¼æ¥
      </button>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn" id="saveBtn" style="flex:1">ä¿å­˜å›¾ç‰‡</button>
  </div>

  <canvas id="stitchCanvas" style="display:none"></canvas>

  <script>
    let imageFiles = []; // å­˜å‚¨æ–‡ä»¶è·¯å¾„
    let direction = 'horizontal';
    let stitchedImage = null;
    const tempDir = '/data/user/0/com.tf.mt.TL2/files/';
    const saveDir = '/storage/emulated/0/Download/';
    const maxResolution = 1920; // å•è¾¹æœ€å¤§åˆ†è¾¨ç‡
    const maxSize = 9 * 1024 * 1024; // 9MB

    const imageInput = document.getElementById('imageInput');
    const imageStrip = document.getElementById('imageStrip');
    const preview = document.getElementById('stitchPreview');
    const stitchCanvas = document.getElementById('stitchCanvas');
    const ctx = stitchCanvas.getContext('2d');

    // æ£€æŸ¥å­˜å‚¨æƒé™
    function checkStoragePermission() {
      if (typeof webapp === 'undefined') {
        alert('webapp æ¥å£æœªå®šä¹‰');
        return false;
      }
      if (!webapp.bestow()) {
        webapp.rights();
        webapp.toast('è¯·æˆäºˆå­˜å‚¨æƒé™ä»¥æ“ä½œæ–‡ä»¶');
        return false;
      }
      return true;
    }

    // ä¿å­˜å›¾ç‰‡ï¼ˆä¸å‹ç¼©ï¼‰
    function saveImage(file, callback) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const fileName = `temp_${Date.now()}_${Math.random().toString(36).slice(2, 8)}.jpg`;

          if (!checkStoragePermission()) {
            callback(null);
            return;
          }

          try {
            webapp.savefile(`${tempDir}${fileName}`, ev.target.result);
            callback({ path: `${tempDir}${fileName}`, dataUrl: ev.target.result });
          } catch (e) {
            webapp?.toast('ä¿å­˜ä¸´æ—¶å›¾ç‰‡å¤±è´¥');
            console.error(e);
            callback(null);
          }
        };
        img.onerror = () => {
          webapp?.toast('å›¾ç‰‡åŠ è½½å¤±è´¥');
          callback(null);
        };
        img.src = ev.target.result;
      };
      reader.onerror = () => {
        webapp?.toast('è¯»å–å›¾ç‰‡å¤±è´¥');
        callback(null);
      };
      reader.readAsDataURL(file);
    }

    // æ›´æ–°å›¾ç‰‡æ¡
    function updateImageStrip() {
      imageStrip.innerHTML = '';

      imageFiles.forEach((file, i) => {
        const div = document.createElement('div');
        div.className = 'image-card';
        div.innerHTML = `
          <img src="${file.dataUrl}" />
          <div class="overlay">
            <button class="overlay-btn" data-action="replace">â†»</button>
          </div>
        `;
        
        div.addEventListener('click', (e) => {
          const action = e.target.closest('[data-action]')?.dataset.action;
          if (action === 'replace') {
            replaceImage(i);
          } else {
            preview.innerHTML = `<img src="${file.dataUrl}" alt="é¢„è§ˆå›¾" style="max-height:100%">`;
          }
        });
        
        imageStrip.appendChild(div);
      });

      if (imageFiles.length < 9) {
        const addBtn = document.createElement('div');
        addBtn.className = 'image-card add-card';
        addBtn.textContent = 'â•';
        addBtn.addEventListener('click', () => {
          imageInput.click();
        });
        imageStrip.appendChild(addBtn);
      }
    }

    // æ›¿æ¢å›¾ç‰‡
    function replaceImage(index) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          saveImage(file, (result) => {
            if (result) {
              // åˆ é™¤æ—§å›¾ç‰‡
              if (imageFiles[index]?.path) {
                try {
                  webapp.awayfile(imageFiles[index].path);
                } catch (e) {
                  console.error('åˆ é™¤æ—§å›¾ç‰‡å¤±è´¥', e);
                }
              }
              imageFiles[index] = result;
              updateImageStrip();
              stitchedImage = null;
              preview.innerHTML = '<div class="preview-placeholder">ğŸ–¼ï¸</div>';
            }
          });
        }
      };
      input.click();
    }

    // åˆ é™¤æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡
    function clearTempImages() {
      imageFiles.forEach(file => {
        if (file.path) {
          try {
            webapp.awayfile(file.path);
          } catch (e) {
            console.error('åˆ é™¤ä¸´æ—¶å›¾ç‰‡å¤±è´¥', e);
          }
        }
      });
      imageFiles = [];
      updateImageStrip();
      stitchedImage = null;
      preview.innerHTML = '<div class="preview-placeholder">ğŸ–¼ï¸</div>';
    }

    document.querySelectorAll('.direction-btn').forEach(btn => {
      btn.onclick = () => {
        direction = btn.dataset.direction;
        document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        preview.className = 'preview-container ' + direction;
      };
    });

    imageInput.addEventListener('change', e => {
      const files = Array.from(e.target.files).slice(0, 9 - imageFiles.length);
      if (files.length === 0) return;
      
      let count = 0;

      files.forEach(file => {
        saveImage(file, (result) => {
          if (result) {
            imageFiles.push(result);
          }
          count++;
          if (count === files.length) {
            updateImageStrip();
            stitchedImage = null;
            preview.innerHTML = '<div class="preview-placeholder">ğŸ–¼ï¸</div>';
          }
        });
      });

      e.target.value = '';
    });

    document.getElementById('stitchBtn').addEventListener('click', () => {
      if (imageFiles.length === 0) {
        webapp?.toast('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        return;
      }

      let maxWidth = 0, maxHeight = 0;
      let loadedImages = [];

      // é€ä¸€åŠ è½½å›¾ç‰‡
      let loadCount = 0;
      imageFiles.forEach((file, i) => {
        const img = new Image();
        img.onload = () => {
          maxWidth = Math.max(maxWidth, img.width);
          maxHeight = Math.max(maxHeight, img.height);
          loadedImages[i] = img;
          loadCount++;
          if (loadCount === imageFiles.length) {
            // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå¼€å§‹æ‹¼æ¥
            stitchImages(loadedImages, maxWidth, maxHeight);
          }
        };
        img.onerror = () => {
          webapp?.toast(`åŠ è½½å›¾ç‰‡ ${file.path} å¤±è´¥`);
          loadCount++;
          if (loadCount === imageFiles.length) {
            stitchImages(loadedImages, maxWidth, maxHeight);
          }
        };
        img.src = file.dataUrl; // ä½¿ç”¨ dataUrl åŠ è½½
      });
    });

    function stitchImages(loadedImages, maxWidth, maxHeight) {
      let canvasWidth = direction === 'horizontal' ? maxWidth * loadedImages.length : maxWidth;
      let canvasHeight = direction === 'vertical' ? maxHeight * loadedImages.length : maxHeight;

      try {
        stitchCanvas.width = canvasWidth;
        stitchCanvas.height = canvasHeight;

        loadedImages.forEach((img, i) => {
          if (img) {
            let x = direction === 'horizontal' ? i * maxWidth : 0;
            let y = direction === 'vertical' ? i * maxHeight : 0;
            ctx.drawImage(img, x, y, maxWidth, maxHeight);
          }
        });

        stitchedImage = stitchCanvas.toDataURL('image/jpeg', 0.9);
        preview.innerHTML = `<img src="${stitchedImage}" alt="é¢„è§ˆå›¾" style="max-height:100%">`;
        webapp?.toast('æ‹¼æ¥å®Œæˆ');

        // æ¸…ç†ç”»å¸ƒ
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      } catch (e) {
        webapp?.toast('æ‹¼æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯å†…å­˜ä¸è¶³ï¼Œè¯·å‡å°‘å›¾ç‰‡æ•°é‡');
        console.error(e);
      }
    }

    document.getElementById('saveBtn').onclick = () => {
      if (!stitchedImage) {
        webapp?.toast('è¯·å…ˆæ‹¼æ¥å›¾ç‰‡');
        return;
      }

      if (!checkStoragePermission()) return;

      const timestamp = Date.now();
      const fileName = `stitched_${timestamp}.jpg`;
      const base64Data = stitchedImage.replace(/^data:image\/jpeg;base64,/, '');

      try {
        // ä¿å­˜åˆ° Download ç›®å½•
        webapp.savefile(`${saveDir}${fileName}`, `data:image/jpeg;base64,${base64Data}`);
        webapp.toast(`å›¾ç‰‡å·²ä¿å­˜åˆ° ${saveDir}${fileName}`);

        // åˆ é™¤ä¸´æ—¶å›¾ç‰‡
        clearTempImages();
      } catch (e) {
        webapp?.toast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨æƒé™æˆ–è·¯å¾„');
        console.error(e);
      }
    };

    // åˆå§‹åŒ–
    updateImageStrip();
  </script>
</body>
</html>