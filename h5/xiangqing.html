<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åº”ç”¨è¯¦æƒ…</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #F2F2F7;
            --text-main: #000000;
            --text-sec: #8E8E93;
            --card-bg: #FFFFFF;
        }

        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            font-family: -apple-system, "SF Pro SC", "SF Pro Display", "PingFang SC", sans-serif;
            color: var(--text-main);
            line-height: 1.5;
            width: 100%;
            overflow-x: hidden; /* å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
            -webkit-text-size-adjust: 100%;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .nav-bar {
            position: fixed;
            top: 0;
            width: 100%;
            height: 44px;
            z-index: 900;
            display: flex;
            align-items: center;
            padding: 0 16px;
            margin-top: env(safe-area-inset-top);
        }

        .back-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.05);
        }

        .back-icon {
            width: 10px;
            height: 10px;
            border-left: 2px solid var(--ios-blue);
            border-bottom: 2px solid var(--ios-blue);
            transform: rotate(45deg);
            margin-left: 2px;
        }

        /* åº”ç”¨å¤´éƒ¨ */
        .app-header {
            padding: calc(60px + env(safe-area-inset-top)) 20px 24px;
            display: flex;
            align-items: flex-start;
        }

        .app-icon {
            width: 100px;
            height: 100px;
            border-radius: 22px;
            background: linear-gradient(135deg, #f5f5f7 0%, #e3e3e8 100%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-right: 20px;
            flex-shrink: 0;
            border: 0.5px solid rgba(0,0,0,0.1);
        }

        .app-title-group {
            flex: 1;
            min-width: 0; /* å¿…é¡»åŠ è¿™è¡Œï¼Œå¦åˆ™ flex å­é¡¹ä¼šè¢«å†…å®¹æ’‘å¼€ */
            overflow: hidden;
        }
        .app-name { 
            font-size: 24px; 
            font-weight: 700; 
            margin-bottom: 4px; 
            letter-spacing: -0.5px; 
            white-space: nowrap;      /* å¼ºåˆ¶å•è¡Œ */
            overflow: hidden;         /* è¶…å‡ºéƒ¨åˆ†éšè— */
            text-overflow: ellipsis;  /* å¿…é¡»æ˜¾ç¤ºçœç•¥å· */
        }
        .app-package-container {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%; /* é™åˆ¶ä¸ºçˆ¶çº§å®½åº¦ */
        }
        .app-package {
            font-size: 13px;
            color: var(--text-sec);
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            white-space: nowrap;      /* å¼ºåˆ¶å•è¡Œ */
            overflow: hidden;         /* è¶…å‡ºéƒ¨åˆ†éšè— */
            text-overflow: ellipsis;  /* å¿…é¡»æ˜¾ç¤ºçœç•¥å· */
            flex: 0 1 auto;           /* å…è®¸ç¼©å°ï¼Œä½†ä¸è‡ªåŠ¨æ”¾å¤§ */
            min-width: 0;              /* è§£å†³ Flex å¸ƒå±€ä¸‹ä¸æ‰“ç‚¹çš„å…³é”® */
        }
        .app-package-arrow {
            font-size: 13px;
            color: var(--text-sec);
            flex-shrink: 0;           /* ç»å¯¹ä¸å…è®¸è¢«å‹ç¼© */
        }

        /* æ ¸å¿ƒå‚æ•°åŒº */
        .info-grid {
            display: flex;
            overflow-x: auto;
            padding: 0 20px;
            gap: 24px;
            margin-bottom: 30px;
            -webkit-overflow-scrolling: touch;
        }
        .info-grid::-webkit-scrollbar { display: none; }
        .info-item {
            flex-shrink: 0;
            text-align: center;
            min-width: 75px;
            position: relative;
        }
        .info-item:not(:last-child)::after {
            content: ""; position: absolute; right: -12px; top: 20%; height: 60%; width: 0.5px; background: #D1D1D6;
        }
        .info-label { font-size: 11px; color: var(--text-sec); font-weight: 600; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 700; color: #48484A; }

        /* å†…å®¹ç‰ˆå—å…±é€š */
        .section {
            padding: 24px 20px;
            border-top: 0.5px solid var(--ios-gray);
        }
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }

        /* æˆªå›¾é¢„è§ˆ */
        .screenshot-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
        }
        .screenshot-list::-webkit-scrollbar { display: none; }
        .screenshot-item {
            width: 180px;
            height: 320px;
            background: #f5f5f7;
            border-radius: 12px;
            flex-shrink: 0;
            border: 0.5px solid rgba(0,0,0,0.05);
            background-size: cover;
            background-position: center;
        }

        .description { font-size: 15px; color: #3A3A3C; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; }

        /* è¯„è®ºåŒºé‡æ„æ ·å¼ */
        .comment-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .comment-card {
            background: #F9F9FB;
            border-radius: 15px;
            padding: 16px;
            border: 0.5px solid rgba(0,0,0,0.03);
            -webkit-user-select: none; /* ç¦ç”¨ç³»ç»Ÿé€‰æ‹© */
            -webkit-touch-callout: none; /* ç¦ç”¨ iOS ç³»ç»Ÿå¼¹å‡ºæ¡† */
            user-select: none;
        }
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            background: linear-gradient(45deg, #FF9500, #FFCC00); /* é»˜è®¤å¤´åƒèƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        .user-meta {
            flex: 1;
        }
        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
        }
        .comment-time {
            font-size: 11px;
            color: var(--text-sec);
        }
        .comment-body {
            font-size: 14px;
            color: #3A3A3C;
            line-height: 1.5;
        }

        /* åº•éƒ¨å›ºå®šæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        /* ä¸‹è½½è¿›åº¦å¼¹çª— */
        .download-progress-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .progress-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .progress-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--ios-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: var(--ios-blue);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-sec);
            text-align: center;
            margin-bottom: 20px;
        }

        .progress-cancel {
            width: 100%;
            height: 44px;
            background: var(--ios-gray);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
        }

        .progress-cancel:active {
            background: #e0e0e5;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            background: var(--ios-gray);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--ios-blue);
            flex-shrink: 0;
        }

        .get-btn-main {
            flex: 1;
            height: 44px;
            background: var(--ios-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            transition: transform 0.1s;
        }
        .get-btn-main:active { transform: scale(0.98); opacity: 0.9; }

        /* æŠ•å¸å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            z-index: 2000;
            align-items: flex-end;
        }
        .modal-sheet {
            width: 100%;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px 20px calc(30px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        .modal-sheet.show { transform: translateY(0); }
        .modal-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .coin-options { display: flex; gap: 15px; }
        .coin-opt {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--ios-gray);
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .coin-opt:active { border-color: var(--ios-blue); background: rgba(0,122,255,0.05); }
        .coin-num { font-size: 24px; font-weight: 800; color: var(--ios-blue); display: block; }
        .coin-label { font-size: 13px; color: var(--text-sec); }

        /* è¯„è®ºå¼¹çª—æ ·å¼ */
        .star-rating {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }
        .star-rating span {
            font-size: 24px;
            color: #D1D1D6;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating span.active {
            color: #FF9500;
        }
        .comment-input {
            width: 100%;
            min-height: 100px;
            border: 1px solid var(--ios-gray);
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 20px;
        }
        .comment-input:focus {
            outline: none;
            border-color: var(--ios-blue);
        }
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .upload-item {
            width: 100%;
            aspect-ratio: 1;
            background: var(--ios-gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-sec);
            position: relative;
            overflow: hidden;
        }
        .upload-item.upload-add {
            cursor: pointer;
            border: 2px dashed var(--ios-gray);
            background: transparent;
        }
        .upload-item.upload-add:active {
            background: rgba(0, 122, 255, 0.05);
        }
        .upload-del {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }
        .upload-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <nav class="nav-bar">
        <div class="back-btn" onclick="handleBack()">
            <div class="back-icon"></div>
        </div>
    </nav>

    <header class="app-header">
        <div class="app-icon"></div>
        <div class="app-title-group">
            <div class="app-name">åŠ è½½ä¸­...</div>
            <div class="app-package-container" onclick="handlePackageClick()">
                <div class="app-package" id="appPackage">åŠ è½½ä¸­...</div>
                <div class="app-package-arrow">â€º</div>
            </div>
        </div>
    </header>

    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">åº”ç”¨å¤§å°</div>
            <div class="info-value"></div>
        </div>
        <div class="info-item">
            <div class="info-label">åº”ç”¨ç‰ˆæœ¬</div>
            <div class="info-value"></div>
        </div>
        <div class="info-item">
            <div class="info-label">å®‰å“ç‰ˆæœ¬</div>
            <div class="info-value"></div>
        </div>
        <div class="info-item">
            <div class="info-label">ç³»ç»Ÿä½æ•°</div>
            <div class="info-value"></div>
        </div>
        <div class="info-item">
            <div class="info-label">åˆ†äº«æ—¶é—´</div>
            <div class="info-value"></div>
        </div>
        <div class="info-item">
            <div class="info-label">åˆ†äº«ç”¨æˆ·</div>
            <div class="info-value"></div>
        </div>
    </div>

    <section class="section">
        <div class="section-title">æˆªå›¾</div>
        <div class="screenshot-list">
            </div>
    </section>

    <section class="section">
        <div class="section-title">ç®€ä»‹</div>
        <div class="description">
            åŠ è½½ä¸­...
        </div>
    </section>

    <section class="section" style="margin-bottom: 110px;">
        <div class="section-title">
            è¯„è®º 
            <span onclick="openCommentModal()" style="font-size: 14px; color: var(--ios-blue); font-weight: normal; cursor: pointer;">å†™è¯„è®º</span>
        </div>
        
        <div class="comment-container">
            <div style="text-align: center; padding: 20px; color: var(--text-sec);">åŠ è½½ä¸­...</div>
        </div>
    </section>

    <div class="modal-overlay" id="commentModal" onclick="closeCommentModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-title">å‘è¡¨è¯„è®º</div>
            
            <div class="star-rating" id="starRating">
                <span onclick="setRating(1)">â˜…</span>
                <span onclick="setRating(2)">â˜…</span>
                <span onclick="setRating(3)">â˜…</span>
                <span onclick="setRating(4)">â˜…</span>
                <span onclick="setRating(5)">â˜…</span>
            </div>

            <textarea class="comment-input" id="commentContent" placeholder="è¯´è¯´ä½ çš„ä½¿ç”¨å¿ƒå¾—..."></textarea>

            <div class="upload-grid" id="imageGrid">
                <div class="upload-item upload-add" onclick="triggerUpload()">+</div>
            </div>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(event)">

            <button class="get-btn-main" style="width:100%" onclick="submitComment()">ç«‹å³å‘è¡¨</button>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="btn-icon" onclick="toggleCollect()">
            <span id="collectIcon" style="font-size: 18px;">â˜†</span>
            <span>æ”¶è—</span>
        </div>
        <button class="get-btn-main" id="downloadBtn" onclick="startDownload()">è·å–</button>
        <div class="btn-icon" onclick="openCoinModal()">
            <span style="font-size: 18px;">ğŸª™</span>
            <span id="coinText">æŠ•å¸</span>
        </div>
    </div>

    <div class="modal-overlay" id="coinModal" onclick="closeCoinModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-title">ä¸ºåº”ç”¨æŠ•å¸</div>
            <div class="coin-options">
                <div class="coin-opt" onclick="doCoin(1)">
                    <span class="coin-num">1</span>
                    <span class="coin-label">ç§¯åˆ†</span>
                </div>
                <div class="coin-opt" onclick="doCoin(2)">
                    <span class="coin-num">2</span>
                    <span class="coin-label">ç§¯åˆ†</span>
                </div>
            </div>
            <button class="get-btn-main" style="width:100%; margin-top: 20px; background: #eee; color: #333;" onclick="closeCoinModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä¸‹è½½è¿›åº¦å¼¹çª— -->
    <div class="download-progress-modal" id="downloadProgressModal" style="display: none;">
        <div class="progress-container">
            <div class="progress-title">ä¸‹è½½ä¸­</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            <button class="progress-cancel" onclick="cancelDownload()">å–æ¶ˆä¸‹è½½</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨æˆªå›¾æ•°ç»„
        let screenshotUrls = [];
        let isSaving = false;
        let pageActive = true; // é¡µé¢çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºæ£€æµ‹é¡µé¢æ˜¯å¦æ´»è·ƒ
        let currentDownloadTask = null; // å½“å‰ä¸‹è½½ä»»åŠ¡

        function handleBack() {
            pageActive = false; // æ ‡è®°é¡µé¢ä¸ºéæ´»è·ƒçŠ¶æ€
            if (window.plus) {
                var webview = plus.webview.currentWebview();
                // å°è¯•è¿”å›åˆ°ä¸Šä¸€ä¸ªé¡µé¢
                webview.back();
                // å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªé¡µé¢ï¼Œåˆ™å…³é—­å½“å‰é¡µé¢
                setTimeout(function() {
                    webview.canBack(function(e) {
                        if (!e.canBack) {
                            webview.close('auto');
                        }
                    });
                }, 100);
            } else {
                window.history.back();
            }
        }

        function handlePackageClick() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆåŒ…åç‚¹å‡»æ“ä½œ');
                return;
            }
            
            const packageElement = document.getElementById('appPackage');
            if (!packageElement) {
                console.log('åŒ…åå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const packageName = packageElement.textContent.trim();
            if (!packageName || packageName === 'åŠ è½½ä¸­...') {
                return;
            }
            
            var url = 'moreapp.html?baoming=' + encodeURIComponent(packageName);
            if (window.plus) {
                var ws = plus.webview.create(url, url, {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = url;
            }
        }

        // æ£€æŸ¥é¡µé¢æ˜¯å¦æ´»è·ƒ
        function isPageActive() {
            return pageActive;
        }

        function toggleCollect() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæ”¶è—æ“ä½œ');
                return;
            }
            
            const icon = document.getElementById('collectIcon');
            if (!icon) {
                console.log('æ”¶è—æŒ‰é’®ä¸å­˜åœ¨');
                return;
            }
            
            const appId = getUrlParam('id');
            
            if (icon.innerText === 'â˜†') {
                // æ·»åŠ æ”¶è—
                icon.innerText = 'â˜…';
                icon.style.color = '#FF9500';
                addToCollection(appId);
                showToast('æ”¶è—æˆåŠŸ');
            } else {
                // å–æ¶ˆæ”¶è—
                icon.innerText = 'â˜†';
                icon.style.color = 'var(--ios-blue)';
                removeFromCollection(appId);
                showToast('å–æ¶ˆæ”¶è—');
            }
        }

        /**
         * æ·»åŠ åº”ç”¨åˆ°æ”¶è—
         * @param {string} appId åº”ç”¨ID
         */
        function addToCollection(appId) {
            try {
                // è¯»å–ç°æœ‰æ”¶è—
                let collection = JSON.parse(localStorage.getItem('appCollection') || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
                if (!collection.some(item => item.id === appId)) {
                    // è·å–å½“å‰åº”ç”¨ä¿¡æ¯
                    const app = getCurrentAppInfo();
                    if (app) {
                        const collectionItem = {
                            id: appId,
                            name: app.name,
                            icon: app.icon,
                            description: app.description,
                            timestamp: Date.now()
                        };
                        
                        // æ·»åŠ åˆ°æ”¶è—åˆ—è¡¨
                        collection.push(collectionItem);
                        
                        // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('appCollection', JSON.stringify(collection));
                    }
                }
            } catch (error) {
                console.error('æ·»åŠ æ”¶è—å¤±è´¥:', error);
            }
        }

        /**
         * ä»æ”¶è—ä¸­ç§»é™¤åº”ç”¨
         * @param {string} appId åº”ç”¨ID
         */
        function removeFromCollection(appId) {
            try {
                // è¯»å–ç°æœ‰æ”¶è—
                let collection = JSON.parse(localStorage.getItem('appCollection') || '[]');
                
                // è¿‡æ»¤æ‰è¦ç§»é™¤çš„åº”ç”¨
                const newCollection = collection.filter(item => item.id !== appId);
                
                // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
                localStorage.setItem('appCollection', JSON.stringify(newCollection));
            } catch (error) {
                console.error('ç§»é™¤æ”¶è—å¤±è´¥:', error);
            }
        }

        /**
         * è·å–å½“å‰åº”ç”¨ä¿¡æ¯
         * @returns {object} åº”ç”¨ä¿¡æ¯
         */
        function getCurrentAppInfo() {
            try {
                const appIcon = document.querySelector('.app-icon');
                const appName = document.querySelector('.app-name');
                const appDesc = document.querySelector('.description');
                
                return {
                    name: appName ? appName.textContent : '',
                    icon: appIcon ? appIcon.style.backgroundImage.replace(/url\(['"]?(.*?)['"]?\)/, '$1') : '',
                    description: appDesc ? appDesc.textContent : ''
                };
            } catch (error) {
                console.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        /**
         * æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²æ”¶è—
         * @param {string} appId åº”ç”¨ID
         * @returns {boolean} æ˜¯å¦å·²æ”¶è—
         */
        function isCollected(appId) {
            try {
                const collection = JSON.parse(localStorage.getItem('appCollection') || '[]');
                return collection.some(item => item.id === appId);
            } catch (error) {
                console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }

        /**
         * æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
         */
        function updateCollectButton() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€');
                return;
            }
            
            const appId = getUrlParam('id');
            const icon = document.getElementById('collectIcon');
            
            if (!icon) {
                console.log('æ”¶è—æŒ‰é’®ä¸å­˜åœ¨');
                return;
            }
            
            if (isCollected(appId)) {
                icon.innerText = 'â˜…';
                icon.style.color = '#FF9500';
            } else {
                icon.innerText = 'â˜†';
                icon.style.color = 'var(--ios-blue)';
            }
        }

        const modal = document.getElementById('coinModal');
        const sheet = modal.querySelector('.modal-sheet');

        function openCoinModal() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæ‰“å¼€æŠ•å¸å¼¹çª—');
                return;
            }
            
            if (modal && sheet) {
                modal.style.display = 'flex';
                setTimeout(() => {
                    if (isPageActive() && sheet) {
                        sheet.classList.add('show');
                    }
                }, 10);
            }
        }

        function closeCoinModal() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆå…³é—­æŠ•å¸å¼¹çª—');
                return;
            }
            
            if (modal && sheet) {
                sheet.classList.remove('show');
                setTimeout(() => {
                    if (isPageActive() && modal) {
                        modal.style.display = 'none';
                    }
                }, 300);
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨åº”ç”¨ä¿¡æ¯
        let currentAppInfo = null;
        
        function doCoin(num) {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæŠ•å¸æ“ä½œ');
                return;
            }
            
            const appId = getUrlParam('id');
            const userMail = localStorage.getItem('usermail');
            
            if (!userMail) {
                showToast('è¯·å…ˆç™»å½•');
                closeCoinModal();
                return;
            }
            
            if (!currentAppInfo) {
                showToast('åº”ç”¨ä¿¡æ¯åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
                closeCoinModal();
                return;
            }
            
            // 1. åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„åº”ç”¨
            if (currentAppInfo.é‚®ç®± === userMail) {
                showToast('ä¸èƒ½ç»™è‡ªå·±çš„åº”ç”¨æŠ•å¸');
                closeCoinModal();
                return;
            }
            
            // 2. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
            const userCoin = parseInt(localStorage.getItem('userpoints') || '0');
            if (userCoin < num) {
                showToast('ç§¯åˆ†ä¸è¶³');
                closeCoinModal();
                return;
            }
            
            // 3. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            // 4. å‘é€æŠ•å¸è¯·æ±‚
            const mode = num === 1 ? 'coin_1' : 'coin_2';
            const requestData = {
                mail: userMail,
                appid: appId
            };
            
            fetch(`https://apirank.qujiaweb.top/?mode=${mode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (!isPageActive()) return;
                
                hideLoading();
                closeCoinModal();
                
                if (data.code === 200) {
                    showToast('æŠ•å¸æˆåŠŸï¼');
                    // æ›´æ–°æœ¬åœ°ç§¯åˆ†
                    const newCoin = userCoin - num;
                    localStorage.setItem('userpoints', newCoin.toString());
                    // æ›´æ–°é¡µé¢ä¸Šçš„æŠ•å¸æ•°é‡
                    updateCoinDisplay();
                } else {
                    showToast(data.msg || 'æŠ•å¸å¤±è´¥');
                }
            })
            .catch(error => {
                if (!isPageActive()) return;
                
                hideLoading();
                closeCoinModal();
                showToast('æŠ•å¸å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                console.error('æŠ•å¸è¯·æ±‚å¤±è´¥:', error);
            });
        }
        
        function updateCoinDisplay() {
            if (!isPageActive()) return;
            
            const coinBtnText = document.getElementById('coinText');
            if (coinBtnText && currentAppInfo) {
                const currentAppCoin = parseInt(currentAppInfo.ç§¯åˆ† || 0);
                coinBtnText.textContent = currentAppCoin > 99 ? '99å¸+' : currentAppCoin + 'å¸';
            }
        }

        function startDownload() {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆä¸‹è½½æ“ä½œ');
                return;
            }
            
            const btn = event.target;
            if (!btn) {
                console.log('ä¸‹è½½æŒ‰é’®ä¸å­˜åœ¨');
                return;
            }
            
            btn.innerText = "å¤„ç†ä¸­...";
            setTimeout(() => {
                if (isPageActive()) {
                    alert('å·²ä¸ºæ‚¨æ‹‰èµ·å®‰å…¨ä¸‹è½½é€šé“');
                    btn.innerText = "è·å–åº”ç”¨";
                }
            }, 1000);
        }

        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function showLoading() {
            if (window.plus) {
                plus.nativeUI.showWaiting('åŠ è½½ä¸­...');
            } else {
                document.body.style.opacity = '0.7';
            }
        }

        function hideLoading() {
            if (window.plus) {
                plus.nativeUI.closeWaiting();
            } else {
                document.body.style.opacity = '1';
            }
        }

        // ================= æ–°å¢ï¼šå…¨å±å›¾ç‰‡é¢„è§ˆä¸æƒé™é€»è¾‘ =================
        
        /**
         * è¯·æ±‚æƒé™å¹¶é¢„è§ˆå›¾ç‰‡
         * @param {number} index å½“å‰ç‚¹å‡»çš„å›¾ç‰‡ç´¢å¼•
         */
        function previewScreenshots(index) {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆé¢„è§ˆå›¾ç‰‡');
                return;
            }
            
            if (!window.plus) {
                if (isPageActive()) {
                    alert('è¯·åœ¨Appç¯å¢ƒä¸­é¢„è§ˆ');
                }
                return;
            }

            // 5+ SDK çš„ previewImage æ¥å£
            plus.nativeUI.previewImage(screenshotUrls, {
                current: index,
                loop: true,
                indicator: 'number',
                onLongPress: function(e) {
                    console.log('ç”¨æˆ·é•¿æŒ‰äº†å›¾ç‰‡ï¼š' + e.url);
                    // è°ƒç”¨ä¿å­˜å›¾ç‰‡å‡½æ•°
                    saveImageToGallery(e.url);
                }
            });
        }

        /**
         * ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ
         * @param {string} filePath å›¾ç‰‡è·¯å¾„æˆ–URL
         */
        function saveImageToGallery(filePath) {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆä¿å­˜å›¾ç‰‡æ“ä½œ');
                return;
            }

            if (isSaving) {
                showToast('æ­£åœ¨ä¿å­˜ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            isSaving = true;

            try {
                // ä¼˜å…ˆä½¿ç”¨ plus.gallery.saveï¼ˆæœ€ç¨³å®šçš„APIï¼‰
                if (window.plus && plus.gallery && typeof plus.gallery.save === 'function') {
                    plus.gallery.save(filePath,
                        function() {
                            if (isPageActive()) {
                                isSaving = false;
                                showToast('å›¾ç‰‡ä¿å­˜æˆåŠŸ');
                            }
                        },
                        function(error) {
                            console.log('plus.gallery.save failed:', error);
                            // å¤±è´¥åå°è¯•å…¶ä»–æ–¹æ³•
                            if (isPageActive()) {
                                tryAlternativeSave(filePath);
                            }
                        }
                    );
                } else {
                    tryAlternativeSave(filePath);
                }
            } catch (error) {
                console.log('saveImageToGallery error:', error);
                if (isPageActive()) {
                    isSaving = false;
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™');
                }
            }
        }

        /**
         * å°è¯•å¤‡ç”¨ä¿å­˜æ–¹æ³•
         * @param {string} filePath å›¾ç‰‡è·¯å¾„æˆ–URL
         */
        function tryAlternativeSave(filePath) {
            console.log('å°è¯•å¤‡ç”¨ä¿å­˜æ–¹æ³•:', filePath);
            if (isPageActive()) {
                isSaving = false;
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        /**
         * æ˜¾ç¤ºè½»æç¤º
         * @param {string} message æç¤ºä¿¡æ¯
         */
        function showToast(message) {
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæ˜¾ç¤ºæç¤º:', message);
                return;
            }

            if (window.plus && plus.nativeUI) {
                plus.nativeUI.toast(message);
            } else {
                alert(message);
            }
        }

        // å¢å¼ºçš„å¤åˆ¶å‡½æ•°ï¼ŒåŒ…å«å¤šç§å¤‡ç”¨æ–¹æ¡ˆ
        function copyToClipboardWithFallback(text) {
            // æ–¹æ¡ˆ1: ä½¿ç”¨ç°ä»£Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        console.log('å¤åˆ¶æˆåŠŸ (ç°ä»£API)');
                        showCopySuccess();
                    })
                    .catch(err => {
                        console.warn('ç°ä»£APIå¤åˆ¶å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', err);
                        tryFallbackMethods(text);
                    });
            } else {
                // ç›´æ¥ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                tryFallbackMethods(text);
            }
        }

        function tryFallbackMethods(text) {
            // æ–¹æ¡ˆ2: ä½¿ç”¨HTML5+çš„å¤åˆ¶åŠŸèƒ½
            if (window.plus && plus.device) {
                try {
                    plus.device.setClipboard(text, function() {
                        console.log('å¤åˆ¶æˆåŠŸ (HTML5+)');
                        showCopySuccess();
                    }, function(err) {
                        console.warn('HTML5+å¤åˆ¶å¤±è´¥:', err);
                        tryExecCommand(text);
                    });
                    return;
                } catch (e) {
                    console.warn('HTML5+å¤åˆ¶å¼‚å¸¸:', e);
                }
            }
            
            // æ–¹æ¡ˆ3: ä½¿ç”¨ä¼ ç»Ÿçš„execCommand
            tryExecCommand(text);
        }

        function tryExecCommand(text) {
            // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log('å¤åˆ¶æˆåŠŸ (execCommand)');
                    showCopySuccess();
                } else {
                    console.warn('execCommandå¤åˆ¶å¤±è´¥');
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                console.error('execCommandæ‰§è¡Œå¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function showCopySuccess() {
            showToast('å¯†ç å·²å¤åˆ¶');
        }

        // è§£æè“å¥äº‘é“¾æ¥
        async function parselanzouUrl(url, password) {
            try {
                const apiUrl = `https://api.pearktrue.cn/api/lanzou/api.php?url=${encodeURIComponent(url)}&pwd=${encodeURIComponent(password || '')}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.downloadurl) {
                    return data.data.downloadurl;
                } else {
                    console.error('è“å¥äº‘è§£æå¤±è´¥:', data);
                    return null;
                }
            } catch (error) {
                console.error('è“å¥äº‘è§£æè¯·æ±‚å¤±è´¥:', error);
                return null;
            }
        }

        // æ˜¾ç¤ºä¸‹è½½è¿›åº¦å¼¹çª—
        function showDownloadProgress() {
            if (!isPageActive()) return;
            const modal = document.getElementById('downloadProgressModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // éšè—ä¸‹è½½è¿›åº¦å¼¹çª—
        function hideDownloadProgress() {
            if (!isPageActive()) return;
            const modal = document.getElementById('downloadProgressModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // æ›´æ–°ä¸‹è½½è¿›åº¦
        function updateDownloadProgress(progress, downloadedSize, totalSize) {
            if (!isPageActive()) return;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            if (progressText) {
                const downloaded = formatFileSize(downloadedSize);
                const total = formatFileSize(totalSize);
                progressText.textContent = `${downloaded} / ${total} (${progress}%)`;
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // å–æ¶ˆä¸‹è½½
        function cancelDownload() {
            if (currentDownloadTask) {
                currentDownloadTask.abort();
                currentDownloadTask = null;
                hideDownloadProgress();
                showToast('ä¸‹è½½å·²å–æ¶ˆ');
            }
        }

        // ä½¿ç”¨5+ç¯å¢ƒä¸‹è½½æ–‡ä»¶
        function downloadWithPlus(url) {
            if (!window.plus) {
                console.error('5+ç¯å¢ƒä¸å¯ç”¨');
                return;
            }

            // æ˜¾ç¤ºä¸‹è½½è¿›åº¦å¼¹çª—
            showDownloadProgress();

            // æ˜¾ç¤ºä¸‹è½½è¿›åº¦
            const downloadTask = plus.downloader.createDownload(url, {}, function(download, status) {
                // éšè—è¿›åº¦å¼¹çª—
                hideDownloadProgress();
                currentDownloadTask = null;
                
                if (status === 200) {
                    showToast('ä¸‹è½½å®Œæˆ');
                    // æ‰“å¼€ä¸‹è½½çš„æ–‡ä»¶
                    plus.runtime.openFile(download.filename);
                } else {
                    showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                    console.error('ä¸‹è½½å¤±è´¥:', status);
                }
            });

            // å­˜å‚¨å½“å‰ä¸‹è½½ä»»åŠ¡
            currentDownloadTask = downloadTask;

            // ç›‘å¬ä¸‹è½½è¿›åº¦
            downloadTask.addEventListener('statechanged', function(task, status) {
                if (task.state === 3) { // ä¸‹è½½ä¸­
                    const progress = Math.round((task.downloadedSize / task.totalSize) * 100);
                    console.log('ä¸‹è½½è¿›åº¦:', progress + '%');
                    // æ›´æ–°UIæ˜¾ç¤ºè¿›åº¦
                    updateDownloadProgress(progress, task.downloadedSize, task.totalSize);
                }
            });

            // å¼€å§‹ä¸‹è½½
            downloadTask.start();
        }

        // =============================================================

        async function getAppDetail() {
            const appId = getUrlParam('id');
            if (!appId) {
                if (isPageActive()) {
                    alert('ç¼ºå°‘åº”ç”¨IDå‚æ•°');
                }
                return;
            }

            if (isPageActive()) {
                document.body.style.backgroundColor = '#ffffff';
                document.body.style.opacity = '1';
                showLoading();
            }

            try {
                const userMail = localStorage.getItem('usermail');
                if (!userMail) {
                    if (isPageActive()) {
                        alert('è¯·å…ˆç™»å½•');
                        hideLoading();
                    }
                    return;
                }
                
                // æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æ´»è·ƒï¼Œç„¶åå†å‘èµ·è¯·æ±‚
                if (!isPageActive()) {
                    console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆå‘èµ·è¯·æ±‚');
                    return;
                }
                
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_app_detail&id=${appId}&mail=${userMail}`);
                
                // æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æ´»è·ƒ
                if (!isPageActive()) {
                    console.log('é¡µé¢å·²é”€æ¯ï¼Œç»ˆæ­¢åç»­æ“ä½œ');
                    return;
                }
                
                const data = await response.json();

                // æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æ´»è·ƒ
                if (!isPageActive()) {
                    console.log('é¡µé¢å·²é”€æ¯ï¼Œç»ˆæ­¢åç»­æ“ä½œ');
                    return;
                }

                if (data.fields && data.fields.length > 0) {
                    const app = data.fields[0];
                    if (isPageActive()) {
                        renderAppDetail(app);
                        // æ£€æŸ¥æ˜¯å¦ä¸ºæ—§ç‰ˆæœ¬åº”ç”¨
                        const appIdNum = parseInt(appId);
                        console.log('App ID:', appId, 'Parsed:', appIdNum);
                        if (!isNaN(appIdNum) && appIdNum >= 1 && appIdNum <= 1108) {
                            console.log('Old version app detected, showing warning');
                            // åœ¨æˆªå›¾å’Œç®€ä»‹ä¹‹é—´æ’å…¥æ—§ç‰ˆæœ¬æç¤º
                            const sections = document.querySelectorAll('.section');
                            if (sections.length >= 2) {
                                const screenshotSection = sections[1]; // ç¬¬äºŒä¸ªsectionæ˜¯æˆªå›¾
                                const warningElement = document.createElement('div');
                                warningElement.style.cssText = `
                                    background: #FFF5F5;
                                    border-left: 4px solid #FF6B6B;
                                    padding: 12px 16px;
                                    margin: 10px 20px;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    color: #D32F2F;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                `;
                                warningElement.innerHTML = '<span style="font-size: 16px;"></span> è¯¥åº”ç”¨æ¥è‡ªæ—§ç‰ˆå®¢æˆ·ç«¯ï¼Œå¯èƒ½å­˜åœ¨éƒ¨åˆ†é—®é¢˜';
                                screenshotSection.insertAdjacentElement('afterend', warningElement);
                            }
                        }
                        // âš ï¸
                        // è®°å½•åˆ°å†å²è®°å½•
                        saveToHistory(appId, app);
                        // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
                        updateCollectButton();
                        // è·å–åº”ç”¨è¯„è®º
                        getAppComments(appId);
                    }
                } else if (data.code === 403) {
                    if (isPageActive()) {
                        alert('è´¦å·ç¯å¢ƒå¼‚å¸¸ï¼Œè¯·å‹¿å¤šç«¯ç™»å½•');
                    }
                } else if (data.code === 404) {
                    if (isPageActive()) {
                        alert(data.msg || 'è¯¥åº”ç”¨å·²è¢«åˆ é™¤');
                    }
                } else {
                    if (isPageActive()) {
                        alert('åº”ç”¨å·²åˆ é™¤');
                    }
                }
            } catch (error) {
                console.error('è·å–åº”ç”¨è¯¦æƒ…å¤±è´¥:', error);
                // åªæœ‰åœ¨é¡µé¢æ´»è·ƒæ—¶æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (isPageActive()) {
                    alert('è·å–åº”ç”¨è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } finally {
                // åªæœ‰åœ¨é¡µé¢æ´»è·ƒæ—¶æ‰æ‰§è¡Œæ¸…ç†æ“ä½œ
                if (isPageActive()) {
                    hideLoading();
                    document.body.style.backgroundColor = '#ffffff';
                    document.body.style.opacity = '1';
                }
            }
        }

        /**
         * ä¿å­˜åº”ç”¨åˆ°å†å²è®°å½•
         * @param {string} appId åº”ç”¨ID
         * @param {object} app åº”ç”¨ä¿¡æ¯
         */
        function saveToHistory(appId, app) {
            try {
                // è¯»å–ç°æœ‰å†å²è®°å½•
                let history = JSON.parse(localStorage.getItem('appHistory') || '[]');
                
                // å»é‡ï¼šç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒåº”ç”¨
                history = history.filter(item => item.id !== appId);
                
                // åˆ›å»ºæ–°çš„å†å²è®°å½•é¡¹
                const historyItem = {
                    id: appId,
                    name: handleNullValue(app.åç§°),
                    icon: handleNullValue(app.å›¾æ ‡),
                    description: handleNullValue(app.ç®€ä»‹),
                    timestamp: Date.now()
                };
                
                // å°†æ–°è®°å½•æ·»åŠ åˆ°å¼€å¤´
                history.unshift(historyItem);
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤š20æ¡ï¼‰
                if (history.length > 20) {
                    history = history.slice(0, 20);
                }
                
                // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
                localStorage.setItem('appHistory', JSON.stringify(history));
            } catch (error) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '--';
            const date = new Date(parseInt(timestamp) * 1000);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }

        function handleNullValue(value) {
            return value === null || value === undefined || value === '' ? '--' : value;
        }

        function renderAppDetail(app) {
            // æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æ´»è·ƒ
            if (!isPageActive()) {
                console.log('é¡µé¢å·²é”€æ¯ï¼Œå–æ¶ˆæ¸²æŸ“åº”ç”¨è¯¦æƒ…');
                return;
            }
            
            // å­˜å‚¨åº”ç”¨ä¿¡æ¯åˆ°å…¨å±€å˜é‡
            currentAppInfo = app;
            
            // æ¸²æŸ“åŸºæœ¬ä¿¡æ¯
            const appIcon = document.querySelector('.app-icon');
            if (appIcon && app.å›¾æ ‡) {
                appIcon.style.backgroundImage = `url(${app.å›¾æ ‡})`;
                appIcon.style.backgroundSize = 'cover';
                appIcon.style.backgroundPosition = 'center';
            }

            const appNameElement = document.querySelector('.app-name');
            if (appNameElement) {
                appNameElement.textContent = handleNullValue(app.åç§°);
            }

            const appPackageElement = document.getElementById('appPackage');
            if (appPackageElement) {
                appPackageElement.textContent = app.åŒ…å === null || app.åŒ…å === undefined || app.åŒ…å === '' ? 'æš‚æ— åŒ…å' : app.åŒ…å;
            }

            // æ¸²æŸ“æˆªå›¾å¹¶ç»‘å®šç‚¹å‡»é¢„è§ˆ
            const screenshotList = document.querySelector('.screenshot-list');
            if (screenshotList && app.å›¾ç‰‡) {
                screenshotUrls = app.å›¾ç‰‡.split(',').map(url => url.trim()).filter(url => url !== "");
                screenshotList.innerHTML = '';
                screenshotUrls.forEach((imgUrl, index) => {
                    if (!isPageActive()) return;
                    const imgElement = document.createElement('div');
                    imgElement.className = 'screenshot-item';
                    imgElement.style.backgroundImage = `url(${imgUrl})`;
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    imgElement.onclick = () => {
                        if (isPageActive()) {
                            previewScreenshots(index);
                        }
                    };
                    screenshotList.appendChild(imgElement);
                });
            }

            const infoItems = document.querySelectorAll('.info-item');
            if (infoItems[0]) infoItems[0].querySelector('.info-value').textContent = handleNullValue(app.å¤§å°);
            if (infoItems[1]) infoItems[1].querySelector('.info-value').textContent = handleNullValue(app.ç‰ˆæœ¬);
            if (infoItems[2]) infoItems[2].querySelector('.info-value').textContent = handleNullValue(app.å®‰å“ç‰ˆæœ¬);
            if (infoItems[3]) infoItems[3].querySelector('.info-value').textContent = handleNullValue(app.ä½æ•°);
            if (infoItems[4]) infoItems[4].querySelector('.info-value').textContent = formatTimestamp(app.æ—¶é—´);
            if (infoItems[5]) {
                const shareUserElement = infoItems[5].querySelector('.info-value');
                shareUserElement.textContent = handleNullValue(app.ç”¨æˆ·);
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°åˆ†äº«ç”¨æˆ·çš„ä¸ªäººé¡µé¢
                shareUserElement.style.cursor = 'pointer';
                shareUserElement.onclick = function() {
                    if (!isPageActive()) return;
                    if (app.é‚®ç®±) {
                        const url = `page.html?user=${app.é‚®ç®±}`;
                        if (window.plus) {
                            plus.webview.open(url, url, {backbuttonMaximize:false}, 'pop-in', 300);
                        } else {
                            window.location.href = url;
                        }
                    }
                };
            }

            const descriptionElement = document.querySelector('.description');
            // æ–‡å­—è½¬emojiå‡½æ•°
            function htmlEntityToEmoji(str) {
                return str.replace(/&#(\d+);/g, function(match, code) {
                    return String.fromCodePoint(parseInt(code));
                });
            }

            if (descriptionElement) {
                const description = handleNullValue(app.ç®€ä»‹);
                // å…ˆå°†å­—ç¬¦è¡¨æƒ…è½¬ä¸ºemojiï¼Œå†å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLçš„bræ ‡ç­¾
                const emojiDescription = htmlEntityToEmoji(description);
                const formattedDescription = emojiDescription.replace(/\n/g, '<br>');
                descriptionElement.innerHTML = formattedDescription;
            }

            const coinBtnText = document.getElementById('coinText');
            if (coinBtnText && app.ç§¯åˆ† !== null && app.ç§¯åˆ† !== undefined && app.ç§¯åˆ† !== '') {
                const coinCount = parseInt(app.ç§¯åˆ†);
                coinBtnText.textContent = coinCount > 99 ? '99å¸+' : coinCount + 'å¸';
            }

            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn && app.é“¾æ¥) {
                downloadBtn.onclick = async function(e) {
                    if (!isPageActive()) return;
                    const btn = e.target;
                    btn.innerText = "å¤„ç†ä¸­...";
                    
                    try {
                        const url = app.é“¾æ¥;
                        const password = app.å¯†ç ;
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯è“å¥äº‘é“¾æ¥
                        if (url.includes('lanz')) {
                            // è§£æè“å¥äº‘é“¾æ¥
                            btn.innerText = "è§£æä¸­...";
                            const directUrl = await parselanzouUrl(url, password);
                            
                            if (directUrl) {
                                // è§£ææˆåŠŸï¼Œä½¿ç”¨5+å†…ç½®ä¸‹è½½
                                if (window.plus) {
                                    downloadWithPlus(directUrl);
                                } else {
                                    window.open(directUrl, '_blank');
                                }
                            } else {
                                // è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸé“¾æ¥
                                if (window.plus) {
                                    plus.runtime.openURL(url);
                                } else {
                                    window.open(url, '_blank');
                                }
                            }
                        } 
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´é“¾ï¼ˆåŒ…å«.apkï¼‰
                        else if (url.includes('.apk')) {
                            // ä½¿ç”¨5+å†…ç½®ä¸‹è½½
                            if (window.plus) {
                                downloadWithPlus(url);
                            } else {
                                window.open(url, '_blank');
                            }
                        } 
                        // å…¶ä»–æƒ…å†µï¼Œè·³è½¬æµè§ˆå™¨
                        else {
                            // æ£€æŸ¥æ˜¯å¦æœ‰å¯†ç 
                            if (password && password !== null && password !== '') {
                                // å¤åˆ¶å¯†ç åˆ°å‰ªè´´æ¿
                                copyToClipboardWithFallback(password);
                            }
                            
                            // è·³è½¬æµè§ˆå™¨
                            if (window.plus) {
                                plus.runtime.openURL(url);
                            } else {
                                window.open(url, '_blank');
                            }
                        }
                    } catch (error) {
                        console.error('ä¸‹è½½å¤„ç†å¤±è´¥:', error);
                        showToast('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                    } finally {
                        if (isPageActive()) {
                            btn.innerText = "è·å–";
                        }
                    }
                };
            }
        }

        window.onload = function() {
            getAppDetail();
        };

        // è¯„è®ºç›¸å…³é€»è¾‘
        let currentRating = 0;
        let uploadedImages = [];

        function openCommentModal() {
            const modal = document.getElementById('commentModal');
            const sheet = modal.querySelector('.modal-sheet');
            modal.style.display = 'flex';
            setTimeout(() => sheet.classList.add('show'), 10);
        }

        function closeCommentModal() {
            const modal = document.getElementById('commentModal');
            const sheet = modal.querySelector('.modal-sheet');
            sheet.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // è¯„åˆ†é€»è¾‘
        function setRating(num) {
            currentRating = num;
            const stars = document.querySelectorAll('#starRating span');
            stars.forEach((s, i) => {
                s.classList.toggle('active', i < num);
            });
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerUpload() {
            document.getElementById('fileInput').click();
        }

        // ä¸Šä¼ é€»è¾‘
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (window.plus) {
                plus.nativeUI.showWaiting('ä¸Šä¼ ä¸­...');
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.full_url) {
                    uploadedImages.push(result.full_url);
                    renderUploadGrid();
                } else {
                    showToast('ä¸Šä¼ å¤±è´¥');
                }
            } catch (e) {
                showToast('ä¸Šä¼ å‡ºé”™');
            } finally {
                if (window.plus) plus.nativeUI.closeWaiting();
                event.target.value = ''; // æ¸…ç©ºé€‰æ‹©
            }
        }

        // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆç½‘æ ¼
        function renderUploadGrid() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            uploadedImages.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = 'upload-item';
                item.style.backgroundImage = `url(${url})`;
                item.innerHTML = `<div class="upload-del" onclick="removeImage(${index})">Ã—</div>`;
                grid.appendChild(item);
            });

            // æ·»åŠ æŒ‰é’®
            const addBtn = document.createElement('div');
            addBtn.className = 'upload-item upload-add';
            addBtn.innerText = '+';
            addBtn.onclick = triggerUpload;
            grid.appendChild(addBtn);
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderUploadGrid();
        }

        // emojiè½¬HTMLå®ä½“å‡½æ•°
        function emojiToHtmlEntity(str) {
            return [...str].map(char => {
                const code = char.codePointAt(0);
                if (
                    (code >= 0x1F300 && code <= 0x1F6FF) ||
                    (code >= 0x1F900 && code <= 0x1F9FF) ||
                    (code >= 0x1FA70 && code <= 0x1FAFF) ||
                    (code >= 0x2600 && code <= 0x26FF) ||
                    (code >= 0x2700 && code <= 0x27BF) ||
                    (code >= 0x1F1E6 && code <= 0x1F1FF)
                ) {
                    return `&#${code};`;
                } else {
                    return char;
                }
            }).join('');
        }

        // æäº¤è¯„è®º
        async function submitComment() {
            if (currentRating === 0) {
                showToast('è¯·å…ˆè¿›è¡Œè¯„åˆ†');
                return;
            }
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            const appId = getUrlParam('id');
            const userMail = localStorage.getItem('usermail');
            
            if (!appId || !userMail) {
                showToast('ç¼ºå°‘å¿…è¦å‚æ•°');
                return;
            }

            // å¤„ç†è¯„è®ºå†…å®¹ï¼šemojiè½¬HTMLå®ä½“
            const processedContent = emojiToHtmlEntity(content);

            if (window.plus) {
                plus.nativeUI.showWaiting('æäº¤ä¸­...');
            }

            try {
                const response = await fetch('https://apirank.qujiaweb.top/?mode=submit_comment&mail=' + userMail, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appid: appId,
                        content: processedContent,
                        images: uploadedImages.join(','),
                        mail: userMail,
                        rating: currentRating
                    })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    showToast('å‘è¡¨æˆåŠŸ');
                    closeCommentModal();
                    // æ¸…ç©ºçŠ¶æ€
                    currentRating = 0;
                    uploadedImages = [];
                    document.getElementById('commentContent').value = '';
                    setRating(0);
                    renderUploadGrid();
                    // é‡æ–°åŠ è½½è¯„è®º
                    getAppComments(appId);
                } else {
                    showToast('å‘è¡¨å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                showToast('å‘è¡¨å‡ºé”™');
            } finally {
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }
            }
        }

        // è·å–åº”ç”¨è¯„è®º
        async function getAppComments(appId) {
            const userMail = localStorage.getItem('usermail');
            if (!userMail) return;

            try {
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_app_comments&appid=${appId}&mail=${userMail}`);
                const result = await response.json();
                if (result.fields && result.fields.length > 0) {
                    renderComments(result.fields);
                    // æ›´æ–°è¯„è®ºæŒ‰é’®æ—è¾¹çš„è¯„è®ºæ•°é‡
                    const sections = document.querySelectorAll('.section');
                    let commentSection = null;
                    for (let i = 0; i < sections.length; i++) {
                        const title = sections[i].querySelector('.section-title');
                        if (title && title.textContent.includes('è¯„è®º')) {
                            commentSection = sections[i];
                            break;
                        }
                    }
                    if (commentSection) {
                        const commentTitle = commentSection.querySelector('.section-title');
                        if (commentTitle) {
                            const commentCount = result.fields.filter(comment => !comment.rootid || comment.rootid === '').length;
                            console.log('Comment count:', commentCount);
                            commentTitle.innerHTML = `è¯„è®ºï¼ˆ${commentCount}ï¼‰ <span onclick="openCommentModal()" style="font-size: 14px; color: var(--ios-blue); font-weight: normal; cursor: pointer;">å†™è¯„è®º</span>`;
                        }
                    }
                } else {
                    // æ²¡æœ‰è¯„è®ºï¼Œæ˜¾ç¤ºæš‚æ— è¯„è®º
                    const commentContainer = document.querySelector('.comment-container');
                    if (commentContainer) {
                        commentContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-sec);">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>';
                    }
                }
            } catch (error) {
                console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                // å‡ºé”™æ—¶æ˜¾ç¤ºæš‚æ— è¯„è®º
                const commentContainer = document.querySelector('.comment-container');
                if (commentContainer) {
                    commentContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-sec);">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>';
                }
            }
        }

        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        function renderComments(comments) {
            const commentContainer = document.querySelector('.comment-container');
            if (!commentContainer) return;

            commentContainer.innerHTML = '';
            
            // è¿‡æ»¤rootidä¸ºç©ºçš„è¯„è®º
            const filteredComments = comments.filter(comment => !comment.rootid || comment.rootid === '');
            
            if (filteredComments.length === 0) {
                commentContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-sec);">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>';
                return;
            }
            
            filteredComments.forEach(comment => {
                const commentCard = document.createElement('div');
                commentCard.className = 'comment-card';
                commentCard.dataset.commentId = comment.createdAt;
                commentCard.dataset.commentMail = comment.é‚®ç®±;
                
                // å¤„ç†è¯„åˆ†
                const rating = comment.è¯„åˆ† || 5;
                const ratingStars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
                
                // å¤„ç†å¤´åƒ
                let avatarStyle = 'background: linear-gradient(45deg, #5AC8FA, #007AFF);';
                if (comment.å¤´åƒ) {
                    avatarStyle = `background-image: url(${comment.å¤´åƒ}); background-size: cover; background-position: center;`;
                }
                
                // å¤„ç†è¯„è®ºå†…å®¹ï¼šHTMLå®ä½“è½¬emojiï¼Œæ”¯æŒæ¢è¡Œï¼Œç¦æ­¢æ˜¾ç¤ºHTML
                let processedContent = comment.å†…å®¹;
                // 1. å…ˆå°†HTMLå®ä½“è½¬å›emoji
                processedContent = processedContent.replace(/&#(\d+);/g, function(match, code) {
                    return String.fromCodePoint(parseInt(code));
                });
                // 2. HTMLè½¬ä¹‰ï¼Œé˜²æ­¢HTMLæ ‡ç­¾è¢«è§£æ
                processedContent = processedContent
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                // 3. å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLçš„bræ ‡ç­¾
                processedContent = processedContent.replace(/\n/g, '<br>');
                
                // å¤„ç†å›¾ç‰‡
                let imageHtml = '';
                if (comment.å›¾ç‰‡) {
                    const imageUrls = comment.å›¾ç‰‡.split(',').filter(url => url.trim() !== '');
                    if (imageUrls.length > 0) {
                        imageHtml = `
                            <div class="comment-images" style="margin-top: 10px;">
                                <div class="screenshot-list">
                                    ${imageUrls.map((imgUrl, index) => `
                                        <div class="screenshot-item" style="width: 100px; height: 100px; background-image: url(${imgUrl}); background-size: cover; background-position: center;" onclick="previewCommentImage('${imgUrl}')"></div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                
                commentCard.innerHTML = `
                    <div class="comment-header">
                        <div class="user-avatar" style="${avatarStyle}">${comment.ç”¨æˆ·.charAt(0)}</div>
                        <div class="user-meta">
                            <div class="user-name">${comment.ç”¨æˆ·}</div>
                            <div class="comment-time">${formatTimestamp(comment.æ—¶é—´)}</div>
                        </div>
                        <div style="color: #FF9500; font-size: 12px;">${ratingStars}</div>
                    </div>
                    <div class="comment-body">
                        ${processedContent}
                    </div>
                    ${imageHtml}
                `;
                
                // æ·»åŠ é•¿æŒ‰äº‹ä»¶
                addLongPressEvent(commentCard, comment);
                
                commentContainer.appendChild(commentCard);
            });
        }

        // é•¿æŒ‰äº‹ä»¶å¤„ç†
        function addLongPressEvent(element, comment) {
            let pressTimer = null;
            let startX = 0;
            let startY = 0;

            // ç¦ç”¨ç³»ç»Ÿé»˜è®¤é•¿æŒ‰å¼¹å‡ºèœå•
            element.oncontextmenu = function(e) { e.preventDefault(); return false; };

            element.addEventListener('touchstart', function(e) {
                // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                element.style.transform = 'scale(0.98)';
                element.style.transition = 'transform 0.2s';
                
                pressTimer = setTimeout(function() {
                    // è§¦å‘é•¿æŒ‰é€»è¾‘
                    showActionMenu(element, comment);
                    // è§¦å‘åæ¢å¤ç¼©æ”¾ï¼Œé˜²æ­¢èœå•å¼¹å‡ºåå¡åœ¨ç¼©æ”¾çŠ¶æ€
                    element.style.transform = 'scale(1)';
                }, 600); // ç•¥å¾®å¢åŠ åˆ°600msï¼Œé¿å¼€å¿«é€Ÿç‚¹å‡»
            });

            element.addEventListener('touchmove', function(e) {
                // è®¡ç®—ç§»åŠ¨è·ç¦»
                let moveX = Math.abs(e.touches[0].clientX - startX);
                let moveY = Math.abs(e.touches[0].clientY - startY);
                
                // åªæœ‰å½“æ‰‹æŒ‡ç§»åŠ¨è¶…è¿‡10åƒç´ æ—¶æ‰åˆ¤å®šä¸ºæ»šåŠ¨ï¼Œä»è€Œå–æ¶ˆé•¿æŒ‰
                if (moveX > 10 || moveY > 10) {
                    element.style.transform = 'scale(1)';
                    clearTimeout(pressTimer);
                }
            });

            element.addEventListener('touchend', function() {
                element.style.transform = 'scale(1)';
                clearTimeout(pressTimer);
            });

            element.addEventListener('touchcancel', function() {
                element.style.transform = 'scale(1)';
                clearTimeout(pressTimer);
            });
        }

        // æ˜¾ç¤ºæ“ä½œèœå•
        function showActionMenu(element, comment) {
            console.log('showActionMenu called');
            const userMail = localStorage.getItem('usermail');
            console.log('User mail:', userMail);
            console.log('Comment mail:', comment.é‚®ç®±);
            const isOwnComment = comment.é‚®ç®± === userMail;
            console.log('Is own comment:', isOwnComment);
            
            // ç§»é™¤æ—§èœå•
            const oldMenu = document.querySelector('.action-menu');
            if (oldMenu) {
                document.body.removeChild(oldMenu);
            }
            
            // åˆ›å»ºèœå•å…ƒç´ 
            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                border-radius: 12px;
                padding: 16px 0;
                z-index: 9999;
                font-size: 16px;
                min-width: 180px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: auto;
            `;
            
            // æ·»åŠ èœå•é¡¹
            if (isOwnComment) {
                menu.innerHTML = `
                    <div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">å›å¤</div>
                    <div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">åˆ é™¤</div>
                    <div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">å¤åˆ¶</div>
                `;
            } else {
                menu.innerHTML = `
                    <div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">å›å¤</div>
                    <div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">å¤åˆ¶</div>
                `;
            }
            console.log('Menu HTML:', menu.innerHTML);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const menuItems = menu.querySelectorAll('.menu-item');
            menuItems[0].addEventListener('click', function() {
                handleReplyComment();
            });
            if (menuItems[1]) {
                if (isOwnComment) {
                    menuItems[1].addEventListener('click', function() {
                        handleDeleteComment(comment.æ—¶é—´);
                    });
                    if (menuItems[2]) {
                        menuItems[2].addEventListener('click', function() {
                            handleCopyComment(comment);
                        });
                    }
                } else {
                    menuItems[1].addEventListener('click', function() {
                        handleCopyComment(comment);
                    });
                }
            }
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);
            console.log('Menu added to body');
            
            // æ˜¾ç¤ºèœå•
            setTimeout(function() {
                menu.style.opacity = '1';
                console.log('Menu shown');
            }, 10);
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            setTimeout(function() {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && !element.contains(e.target)) {
                        console.log('Closing menu');
                        menu.style.opacity = '0';
                        setTimeout(function() {
                            if (menu.parentNode) {
                                document.body.removeChild(menu);
                                console.log('Menu removed from body');
                            }
                        }, 300);
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
        
        // å¤„ç†å¤åˆ¶è¯„è®º
        function handleCopyComment(comment) {
            // å¤„ç†è¯„è®ºå†…å®¹ï¼šHTMLå®ä½“è½¬emoji
            let processedContent = comment.å†…å®¹;
            processedContent = processedContent.replace(/&#(\d+);/g, function(match, code) {
                return String.fromCodePoint(parseInt(code));
            });
            
            // ä½¿ç”¨ä¸å¤åˆ¶å¯†ç ç›¸åŒçš„æ–¹å¼å¤åˆ¶è¯„è®º
            copyToClipboardWithFallback(processedContent);
            
            // å…³é—­èœå•
            closeActionMenu();
        }

        // å¤„ç†å›å¤è¯„è®º
        function handleReplyComment() {
            showToast('æ•¬è¯·æœŸå¾…');
            // ç§»é™¤èœå•
            const menu = document.querySelector('.action-menu');
            if (menu) {
                menu.style.opacity = '0';
                setTimeout(function() {
                    if (menu.parentNode) {
                        document.body.removeChild(menu);
                    }
                }, 300);
            }
        }

        // å¤„ç†åˆ é™¤è¯„è®º
        async function handleDeleteComment(commentId) {
            const userMail = localStorage.getItem('usermail');
            if (!userMail) {
                showToast('è¯·å…ˆç™»å½•');
                const menu = document.querySelector('.action-menu');
                if (menu) {
                    menu.style.opacity = '0';
                    setTimeout(function() {
                        if (menu.parentNode) {
                            document.body.removeChild(menu);
                        }
                    }, 300);
                }
                return;
            }
            
            if (window.plus) {
                plus.nativeUI.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', function(res) {
                    if (res.index === 0) {
                        deleteComment(commentId, userMail);
                    }
                    const menu = document.querySelector('.action-menu');
                    if (menu) {
                        menu.style.opacity = '0';
                        setTimeout(function() {
                            if (menu.parentNode) {
                                document.body.removeChild(menu);
                            }
                        }, 300);
                    }
                }, 'æç¤º', ['ç¡®å®š', 'å–æ¶ˆ']);
            } else {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                    deleteComment(commentId, userMail);
                }
                const menu = document.querySelector('.action-menu');
                if (menu) {
                    menu.style.opacity = '0';
                    setTimeout(function() {
                        if (menu.parentNode) {
                            document.body.removeChild(menu);
                        }
                    }, 300);
                }
            }
        }

        // å…³é—­æ“ä½œèœå•
        function closeActionMenu() {
            const menu = document.querySelector('.action-menu');
            if (menu) {
                menu.style.opacity = '0';
                setTimeout(function() {
                    if (menu.parentNode) {
                        document.body.removeChild(menu);
                    }
                }, 300);
            }
        }

        // åˆ é™¤è¯„è®º
        async function deleteComment(commentId, userMail) {
            if (window.plus) {
                plus.nativeUI.showWaiting('åˆ é™¤ä¸­...');
            }
            
            try {
                const response = await fetch('https://apirank.qujiaweb.top/?mode=delete_comment&mail=' + userMail, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comment_id: commentId,
                        mail: userMail
                    })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    // é‡æ–°åŠ è½½è¯„è®º
                    const appId = getUrlParam('id');
                    getAppComments(appId);
                } else {
                    showToast('åˆ é™¤å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                showToast('åˆ é™¤å‡ºé”™');
            } finally {
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }
            }
        }

        // é¢„è§ˆè¯„è®ºå›¾ç‰‡
        function previewCommentImage(imageUrl) {
            if (!window.plus) {
                if (isPageActive()) {
                    alert('è¯·åœ¨Appç¯å¢ƒä¸­é¢„è§ˆ');
                }
                return;
            }

            // 5+ SDK çš„ previewImage æ¥å£
            plus.nativeUI.previewImage([imageUrl], {
                current: 0,
                loop: true,
                indicator: 'number',
                onLongPress: function(e) {
                    console.log('ç”¨æˆ·é•¿æŒ‰äº†å›¾ç‰‡ï¼š' + e.url);
                    // è°ƒç”¨ä¿å­˜å›¾ç‰‡å‡½æ•°
                    saveImageToGallery(e.url);
                }
            });
        }

        document.addEventListener('plusready', function() {
            plus.key.addEventListener('backbutton', handleBack);
        });
    </script>
</body>
</html>