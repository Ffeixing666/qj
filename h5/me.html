<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>个人中心 - 趣加应用</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent-blue: #007AFF;
            --control-bg: #E3E3E6;
            --header-item-height: 34px;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            /* 禁用选中文本复制 */
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* 登录界面 */
        .login-container { padding: 60px 30px; display: flex; flex-direction: column; align-items: center; }
        .login-container h1 { font-size: 28px; margin-bottom: 40px; font-weight: 700; }
        .input-group { width: 100%; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
        .input-group input {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1px solid #ddd; background: #fff; font-size: 16px; outline: none;
        }
        .login-button {
            width: 100%; padding: 15px; background: var(--accent-blue);
            color: #fff; border: none; border-radius: 16px; font-size: 17px;
            font-weight: 600; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,122,255,0.2);
        }

        /* 个人中心 Header */
        header {
            position: sticky; top: 0; background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(25px); z-index: 100; padding: 15px 16px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .profile-left { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 52px; height: 52px; background: #ddd; border-radius: 50%;
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            object-fit: cover;
        }
        .user-meta { display: flex; flex-direction: column; gap: 4px; }
        .username { font-size: 18px; font-weight: 700; }
        
        .points-badge {
            display: flex; align-items: center; background: var(--control-bg);
            padding: 2px 10px; border-radius: 8px; font-size: 13px;
            color: var(--text-secondary); font-weight: 600; width: fit-content;
        }
        .points-star { color: #FF9500; margin-right: 4px; }

        .top-btns { display: flex; align-items: center; gap: 8px; }
        .icon-box {
            width: var(--header-item-height); height: var(--header-item-height);
            background: var(--control-bg); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .header-icon-img { width: 20px; height: 20px; }

        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            background: #FF3B30;
            color: white;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 4px rgba(255, 59, 48, 0.3);
        }

        /* 中间导航 */
        .middle-nav { padding: 10px 16px; display: flex; align-items: center; gap: 20px; }
        .mid-tab-item {
            font-size: 18px; font-weight: 600; color: var(--text-secondary);
            transition: all 0.4s; cursor: pointer;
        }
        .mid-tab-item.active { font-size: 24px; color: var(--text-main); }

        .app-list { padding: 10px 16px 100px 16px; }
        .app-item {
            display: flex; align-items: center; background: var(--card-bg);
            padding: 12px; border-radius: 16px; margin-bottom: 12px;
            overflow: hidden; /* 防止溢出 */
        }
        .app-icon { width: 60px; height: 60px; background: #f0f0f2; border-radius: 14px; margin-right: 14px; flex-shrink: 0; /* 确保图标不被压缩 */ }
        .app-info { flex: 1; min-width: 0; /* 关键：允许内容在Flex容器内正常截断 */ }
        .app-name { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .app-desc { font-size: 12px; color: var(--text-secondary); display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; /* 限制显示1行 */ overflow: hidden; word-break: break-all; }

        /* 底部导航 */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 52px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex;
            justify-content: space-around; align-items: center; z-index: 100;
        }
        .bottom-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #8E8E93; text-decoration: none; flex: 1; height: 100%; cursor: pointer;}
        .bottom-item.active { color: var(--accent-blue); }
        .nav-icon-img { width: 22px; height: 22px; margin-bottom: 2px; }

        #toast {
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; display: none; z-index: 999;
        }

        .fab {
            position: fixed;
            right: 20px;
            bottom: 72px;
            width: 46px;
            height: 46px;
            background: rgba(255, 255, 255, 0.95);
            border: 0.5px solid rgba(0,0,0,0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 300;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 99;
            cursor: pointer;
        }

        /* 加载动画样式 */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            position: relative;
            margin-bottom: 16px;
        }

        .loading-spinner::before, .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            animation-delay: -0.5s;
            border-top-color: var(--text-secondary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 应用状态徽章 */
        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 12px;
            flex-shrink: 0;
        }
        .status-shared { background: #EAF9EE; color: #34C759; }
        .status-failed { background: #FFF0EF; color: #FF3B30; }
        .status-pending { background: #E3F2FD; color: #2196F3; }

        /* 封禁弹窗样式 */
#ban-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
    z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px;
}
.ban-content {
    background: white; width: 90%; max-width: 320px; border-radius: 28px;
    padding: 30px 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.ban-title { color: #ff7675; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
.ban-body {
    color: #636e72; font-size: 13px; line-height: 1.6; text-align: left;
    margin-bottom: 20px; background: #fdf2f2; padding: 15px; border-radius: 16px;
}
.ban-footer { color: #b2bec3; font-size: 12px; border-top: 1px dashed #dfe6e9; padding-top: 15px; }

    </style>
</head>
<body>

    <div id="toast"></div>
    <div id="ban-modal">
    <div class="ban-content">
        <div class="ban-title">⚠️ 当前账号已封禁</div>
        <div class="ban-body">
            可能存在的原因：<br>
            1.上传病毒、低俗等不良内容。<br>
            2.刷评论、引战等违规行为。<br>
            3.抓包、外挂等篡改数据行为。<br><br>
            <strong>账号相关资产已冻结。</strong>
        </div>
        <div class="ban-footer">如有疑问请咨询：110045310@qq.com</div>
    </div>
</div>


    <section id="loginSection" style="display: none;">
        <div class="login-container">
            <h1>Welcome</h1>
            <div class="input-group">
                <label>邮箱</label>
                <input type="email" id="email" placeholder="输入邮箱地址">
            </div>
            <div class="input-group">
                <label>密码</label>
                <input type="password" id="pass" placeholder="输入您的密码">
            </div>
            <button class="login-button" onclick="handleLogin(true)">马上登录</button>
            <button class="login-button" style="background: #f0f0f0; color: #007AFF; margin-top: 15px;" onclick="openRegisterPage()">立即注册</button>
        </div>
    </section>

    <section id="profileSection" style="display: none;">
        <header>
            <div class="profile-left">
                <img src="" class="avatar" id="uAvatar" alt="" onclick="openUserPage()">
                <div class="user-meta">
                    <div class="username" id="uName" onclick="openUserPage()">加载中...</div>
                    <div class="points-badge" onclick="openMallPage()">
                        <span class="points-star">⭐</span>
                        <span id="uPoints">0</span>
                        <span style="margin-left:5px; opacity: 0.5;">&gt;</span>
                    </div>
                </div>
            </div>
            <div class="top-btns">
                <div class="icon-box" onclick="openMessagePage()">
                    <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_N7XqHo5QC_1766889837434.png" class="header-icon-img" alt="消息">
                    <div class="unread-badge" id="unreadBadge" style="display: none;">0</div>
                </div>
                <div class="icon-box" onclick="openSettingPage()">
                    <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_tnm1F1efLp_1766889744283.png" class="header-icon-img" alt="设置">
                </div>
            </div>
        </header>

        <nav class="middle-nav">
            <span class="mid-tab-item active" onclick="switchMidTab(this)">历史</span>
            <span class="mid-tab-item" onclick="switchMidTab(this)">收藏</span>
            <span class="mid-tab-item" onclick="switchMidTab(this)">我的</span>
            <span class="mid-tab-item" onclick="openReviewPage()" id="reviewTab" style="display: none;">审核</span>
        </nav>

        <main class="app-list">
            <div class="app-item">
                <div class="app-icon"></div>
                <div class="app-info">
                    <div class="app-name">暂无历史记录</div>
                    <div class="app-desc">开始探索有趣的网页或应用吧</div>
                </div>
            </div>
        </main>
    </section>

    <div class="fab" onclick="openSharePage()">+</div>

    <nav class="bottom-nav">
        <div onclick="openHomePage()" class="bottom-item">
            <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_v4UVIMr2qe_1766889744125.png" class="nav-icon-img" alt="首页">
            <span>首页</span>
        </div>
        <div class="bottom-item active">
                    <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_C7AQMwmQxj_1766889744280.png" class="nav-icon-img" alt="我的">
                    <span>我的</span>
                </div>
    </nav>

    <script src="https://static2.pgaot.com/Assets/js/jquery-2.2.4.min.js"></script>
    
    <script>
        // 万能返回键逻辑
        document.addEventListener('plusready', function() {
            var webview = plus.webview.currentWebview();
            plus.key.addEventListener('backbutton', function() {
                webview.canBack(function(e) {
                    if (e.canBack) {
                        webview.back();
                    } else {
                        // me.html 现在是子页，直接关闭返回上一层
                        if (plus.webview.all().length > 1) {
                            webview.close('auto'); 
                        } else {
                            history.back();
                        }
                    }
                });
            });
        });

        const API = 'https://apirank.qujiaweb.top/';

        function toast(m) { 
            $('#toast').text(m).stop(true, true).fadeIn().delay(1500).fadeOut(); 
        }

        // 长按事件处理
        function addLongPressEvent(element, item, type) {
            let pressTimer = null;
            let startX = 0;
            let startY = 0;

            // 禁用系统默认长按弹出菜单
            element.oncontextmenu = function(e) { e.preventDefault(); return false; };

            element.addEventListener('touchstart', function(e) {
                // 记录初始触摸位置
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                element.style.transform = 'scale(0.98)';
                element.style.transition = 'transform 0.2s';
                
                pressTimer = setTimeout(function() {
                    // 触发长按逻辑
                    showActionMenu(element, item, type);
                    // 触发后恢复缩放，防止菜单弹出后卡在缩放状态
                    element.style.transform = 'scale(1)';
                }, 600); // 略微增加到600ms，避开快速点击
            });

            element.addEventListener('touchmove', function(e) {
                // 计算移动距离
                let moveX = Math.abs(e.touches[0].clientX - startX);
                let moveY = Math.abs(e.touches[0].clientY - startY);
                
                // 只有当手指移动超过10像素时才判定为滚动，从而取消长按
                if (moveX > 10 || moveY > 10) {
                    element.style.transform = 'scale(1)';
                    clearTimeout(pressTimer);
                }
            });

            element.addEventListener('touchend', function() {
                element.style.transform = 'scale(1)';
                clearTimeout(pressTimer);
            });

            element.addEventListener('touchcancel', function() {
                element.style.transform = 'scale(1)';
                clearTimeout(pressTimer);
            });
        }

        // 检查用户是否是管理员
        function isAdmin() {
            // 从localStorage中获取用户的管理员状态
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            return isAdmin;
        }

        // 检查今天是否已经星标过应用
        function hasStarredToday() {
            const today = new Date().toDateString();
            const lastStarredDate = localStorage.getItem('lastStarredDate');
            return lastStarredDate === today;
        }

        // 标记今天已经星标过应用
        function markStarredToday() {
            const today = new Date().toDateString();
            localStorage.setItem('lastStarredDate', today);
        }

        // 显示操作菜单
        function showActionMenu(element, item, type) {
            // 移除旧菜单
            const oldMenu = document.querySelector('.action-menu');
            if (oldMenu) {
                document.body.removeChild(oldMenu);
            }
            
            // 创建菜单元素
            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                border-radius: 12px;
                padding: 16px 0;
                z-index: 9999;
                font-size: 16px;
                min-width: 180px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: auto;
            `;
            
            // 构建菜单项
            let menuItems = '<div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s;">删除</div>';
            
            // 为管理员用户在历史或收藏页面添加星标选项
            if (isAdmin() && (type === 'history' || type === 'collection')) {
                menuItems += '<div class="menu-item" style="padding: 14px 28px; text-align: center; cursor: pointer; transition: background 0.2s; border-top: 1px solid rgba(255, 255, 255, 0.2);">星标</div>';
            }
            
            menu.innerHTML = menuItems;
            
            document.body.appendChild(menu);
            
            // 显示菜单
            setTimeout(function() {
                menu.style.opacity = '1';
            }, 10);
            
            // 添加点击事件
            const menuItemElements = menu.querySelectorAll('.menu-item');
            menuItemElements[0].addEventListener('click', function() {
                if (type === 'history') {
                    deleteHistory(item.id);
                } else if (type === 'collection') {
                    removeFromCollection(item.id);
                } else if (type === 'app') {
                    confirmDeleteUserApp(item.id);
                }
            });
            
            // 为星标选项添加点击事件
            if (menuItemElements.length > 1) {
                menuItemElements[1].addEventListener('click', function() {
                    if (type === 'history' || type === 'collection') {
                        handleStarApp(item.id);
                    }
                });
            }
            
            // 点击菜单外部关闭菜单
            setTimeout(function() {
                document.addEventListener('click', closeActionMenu);
            }, 100);
        }

        // 处理应用星标操作
        async function handleStarApp(appId) {
            // 检查今天是否已经星标过应用
            if (hasStarredToday()) {
                if (window.plus) {
                    plus.nativeUI.toast('今天已星标过了，明天再来吧');
                } else {
                    toast('今天已星标过了，明天再来吧');
                }
                closeActionMenu();
                return;
            }
            
            try {
                // 显示加载动画
                if (window.plus) {
                    plus.nativeUI.showWaiting('星标中...');
                }
                
                const mail = localStorage.getItem('usermail');
                if (!mail) {
                    toast('请先登录');
                    closeActionMenu();
                    return;
                }
                
                // 调用后端接口更新应用星标
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=star_app&mail=${encodeURIComponent(mail)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: appId, mail: mail })
                });
                
                if (!response.ok) throw new Error('网络响应不正常');
                const res = await response.json();
                
                // 隐藏加载动画
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }
                
                if (res.code === 200) {
                    // 标记今天已经星标过应用
                    markStarredToday();
                    
                    // 显示星标成功提示
                    if (window.plus) {
                        plus.nativeUI.toast('星标成功');
                    } else {
                        toast('星标成功');
                    }
                } else {
                    // 显示星标失败提示
                    if (window.plus) {
                        plus.nativeUI.toast('星标失败');
                    } else {
                        toast('星标失败');
                    }
                }
            } catch (error) {
                console.error('星标应用失败:', error);
                
                // 隐藏加载动画
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }
                
                // 显示错误提示
                if (window.plus) {
                    plus.nativeUI.toast('星标失败，请稍后重试');
                } else {
                    toast('星标失败，请稍后重试');
                }
            } finally {
                // 关闭操作菜单
                closeActionMenu();
            }
        }

        // 关闭操作菜单
        function closeActionMenu() {
            const menu = document.querySelector('.action-menu');
            if (menu) {
                menu.style.opacity = '0';
                setTimeout(function() {
                    if (menu.parentNode) {
                        document.body.removeChild(menu);
                    }
                }, 300);
            }
            document.removeEventListener('click', closeActionMenu);
        }

        $(function() {
            initApp();
        });

        // 页面状态标志，用于跟踪用户是否还在当前页面
        let isPageActive = true;

        function initApp() {
            // 先显示本地存储的数据
            checkLoginStatus();
            
            // 然后尝试刷新获取最新信息
            const savedEmail = localStorage.getItem('usermail_login');
            const savedPass = localStorage.getItem('userpass_login');
            if (savedEmail && savedPass) {
                // 静默刷新获取最新信息
                handleLogin(false, savedEmail, savedPass);
            }
        }

        // 页面切换前调用，设置页面为非活动状态
        function setPageInactive() {
            isPageActive = false;
        }

        function checkLoginStatus() {
            const mail = localStorage.getItem('usermail');
            if (!mail) {
                $('#loginSection').show();
                $('#profileSection').hide();
                // 确保未登录用户的管理员状态为false
                localStorage.removeItem('isAdmin');
            } else {
                $('#loginSection').hide();
                $('#profileSection').show();
                $('#uName').text(htmlEntityToEmoji(localStorage.getItem('username') || '用户'));
// 找到这两行：
// const avatar = localStorage.getItem('userpicture') || 'https://static.codemao.cn/pickduck/S13lipxCge.png';
// $('#uAvatar').attr('src', avatar);

// 替换为这一行：
$('#uAvatar').attr('src', localStorage.getItem('userpicture') || 'https://pics3.baidu.com/feed/962bd40735fae6cd4f84a12d6c5a023443a70f46.jpeg@f_auto?token=6b875220d3d3ca87cb60284c20a74a16').on('error', function(){ this.src='https://pics3.baidu.com/feed/962bd40735fae6cd4f84a12d6c5a023443a70f46.jpeg@f_auto?token=6b875220d3d3ca87cb60284c20a74a16'; });

                $('#uPoints').text(localStorage.getItem('userpoints') || '0');
                
                // 检查是否为管理员
                checkAdminStatus();
                
                // 获取未读消息数量
                getUnreadMessageCount();
                
                // 默认显示历史记录
                setTimeout(showHistory, 100);
            }
        }

        // 检查管理员状态
        async function checkAdminStatus() {
            const mail = localStorage.getItem('usermail');
            if (!mail) return;
            
            try {
                const response = await fetch(`${API}?mode=get_user_info&mail=${encodeURIComponent(mail)}`, {
                    method: 'GET'
                });
                const res = await response.json();
                
                if (res.code === 200 && res.fields && res.fields.length > 0) {
                    const user = res.fields[0];
                    const isAdmin = user['是否管理'] === '是';
                    // 将管理员状态保存到localStorage
                    localStorage.setItem('isAdmin', isAdmin.toString());
                    if (isAdmin) {
                        // 是管理员，显示审核选项
                        document.getElementById('reviewTab').style.display = 'inline-block';
                    }
                }
            } catch (e) {
                console.error('Check Admin Status Error:', e);
            }
        }

        async function handleLogin(isManual = true, autoEmail = null, autoPass = null) {
            const email = autoEmail || $('#email').val().trim();
            const password = autoPass || $('#pass').val().trim();
            if(!email || !password) {
                if(isManual) toast('请输入邮箱密码');
                return;
            }
            if(isManual) toast('正在登录...');
            try {
                const response = await fetch(`${API}?mode=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error('网络响应不正常');
                const res = await response.json();
// 修改 handleLogin 中的判断部分
if (res.code === 200 && res.fields && res.fields.length > 0) {
    // ... 原有的保存 localStorage 逻辑保持不变 ...
    const user = res.fields[0];
    localStorage.setItem('usermail', user["邮箱"]);
    localStorage.setItem('username', user["昵称"]);
    localStorage.setItem('userpicture', user["头像"]);
    localStorage.setItem('userpoints', user["积分"] || '0');
    localStorage.setItem('isAdmin', user["是否管理"] === '是' ? 'true' : 'false');
    localStorage.setItem('usermail_login', email);
    localStorage.setItem('userpass_login', password);
    if (isPageActive) {
        checkLoginStatus();
        if(isManual) toast('登录成功');
        getUnreadMessageCount();
    }
} else if (res.code === 403) {
    // 关键点：处理封禁
    if (isPageActive) {
        $('#ban-modal').css('display', 'flex'); 
        // 封禁时不清除本地缓存，以便用户知道是哪个号被封，但不允许进入 profileSection
        $('#loginSection').show();
        $('#profileSection').hide();
    }
} else {
    // 原有的报错逻辑
    if(isManual) {
        toast('账号或密码错误');
    } else {
        if (isPageActive) {
            localStorage.clear();
            checkLoginStatus();
        }
    }
}

            } catch(e) { 
                console.error('Login Error:', e);
                if(isManual && isPageActive) {
                    toast('无法连接后端，请稍后'); 
                }
            }
        }

        function logout() {
            if(!confirm('确定退出登录？')) return;
            localStorage.clear();
            checkLoginStatus();
        }

        // 文字转emoji函数
        function htmlEntityToEmoji(str) {
            return str.replace(/&#(\d+);/g, function(match, code) {
                return String.fromCodePoint(parseInt(code));
            });
        }

        function switchMidTab(el) {
            $('.mid-tab-item').removeClass('active');
            $(el).addClass('active');
            
            const tabText = $(el).text();
            if (tabText === '我的') {
                getUserApps();
            } else if (tabText === '历史') {
                showHistory();
            } else if (tabText === '收藏') {
                showCollection();
            }
        }

        /**
         * 显示历史记录
         */
        function showHistory() {
            try {
                // 读取历史记录
                const history = JSON.parse(localStorage.getItem('appHistory') || '[]');
                
                const appList = document.querySelector('.app-list');
                if (!appList) return;
                
                // 清空现有列表
                appList.innerHTML = '';
                
                if (history.length === 0) {
                    showEmptyState('暂无历史记录', '开始探索有趣的网页或应用吧');
                    return;
                }
                
                // 添加历史记录
                history.forEach(item => {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item';
                    appItem.onclick = function() {
                    // 页面切换前设置为非活动状态
                    setPageInactive();
                    var url = 'xiangqing.html?id=' + item.id;
                    if (window.plus) {
                        var ws = plus.webview.create(url, url, {
                            backbuttonMaximize: false
                        });
                        ws.show('pop-in', 300);
                    } else {
                        window.location.href = url;
                    }
                };

                    // 添加长按事件
                addLongPressEvent(appItem, item, 'history');

                    const appIcon = document.createElement('div');
                    appIcon.className = 'app-icon';
                    if (item.icon) {
                        appIcon.style.background = `url('${item.icon}') center/cover`;
                    }

                    const appInfo = document.createElement('div');
                    appInfo.className = 'app-info';

                    const appName = document.createElement('div');
                    appName.className = 'app-name';
                    appName.textContent = htmlEntityToEmoji(item.name || '未知应用');

                    const appDesc = document.createElement('div');
                    appDesc.className = 'app-desc';
                    appDesc.textContent = htmlEntityToEmoji(item.description || '暂无简介');

                    appInfo.appendChild(appName);
                    appInfo.appendChild(appDesc);
                    appItem.appendChild(appIcon);
                    appItem.appendChild(appInfo);
                    appList.appendChild(appItem);
                });
            } catch (error) {
                console.error('显示历史记录失败:', error);
                showEmptyState('加载失败', '无法读取历史记录');
            }
        }

        /**
         * 确认删除历史记录
         * @param {string} appId 应用ID
         */
        function confirmDeleteHistory(appId) {
            if (window.plus) {
                // 使用5+ SDK的确认对话框
                plus.nativeUI.confirm('删除这条记录吗？', function(res) {
                    if (res.index === 0) {
                        deleteHistory(appId);
                    }
                }, '提示', ['确定', '取消']);
            } else {
                // 使用浏览器的确认对话框
                if (confirm('删除这条记录吗？')) {
                    deleteHistory(appId);
                }
            }
        }

        /**
         * 删除历史记录
         * @param {string} appId 应用ID
         */
        function deleteHistory(appId) {
            try {
                // 读取现有历史记录
                let history = JSON.parse(localStorage.getItem('appHistory') || '[]');
                
                // 过滤掉要删除的记录
                const newHistory = history.filter(item => item.id !== appId);
                
                // 保存回本地存储
                localStorage.setItem('appHistory', JSON.stringify(newHistory));
                
                // 重新显示历史记录
                showHistory();
                
                // 关闭操作菜单
                closeActionMenu();
                
                // 显示删除成功提示
                if (window.plus) {
                    plus.nativeUI.toast('删除成功');
                } else {
                    toast('删除成功');
                }
            } catch (error) {
                console.error('删除历史记录失败:', error);
                // 关闭操作菜单
                closeActionMenu();
                if (window.plus) {
                    plus.nativeUI.toast('删除失败');
                } else {
                    toast('删除失败');
                }
            }
        }

        /**
         * 显示收藏记录
         */
        function showCollection() {
            try {
                // 读取收藏记录
                const collection = JSON.parse(localStorage.getItem('appCollection') || '[]');
                
                const appList = document.querySelector('.app-list');
                if (!appList) return;
                
                // 清空现有列表
                appList.innerHTML = '';
                
                if (collection.length === 0) {
                    showEmptyState('暂无收藏记录', '收藏喜欢的应用，方便下次查看');
                    return;
                }
                
                // 添加收藏记录
                collection.forEach(item => {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item';
                    appItem.onclick = function() {
                    // 页面切换前设置为非活动状态
                    setPageInactive();
                    var url = 'xiangqing.html?id=' + item.id;
                    if (window.plus) {
                        var ws = plus.webview.create(url, url, {
                            backbuttonMaximize: false
                        });
                        ws.show('pop-in', 300);
                    } else {
                        window.location.href = url;
                    }
                };

                    // 添加长按事件
                addLongPressEvent(appItem, item, 'collection');

                    const appIcon = document.createElement('div');
                    appIcon.className = 'app-icon';
                    if (item.icon) {
                        appIcon.style.background = `url('${item.icon}') center/cover`;
                    }

                    const appInfo = document.createElement('div');
                    appInfo.className = 'app-info';

                    const appName = document.createElement('div');
                    appName.className = 'app-name';
                    appName.textContent = htmlEntityToEmoji(item.name || '未知应用');

                    const appDesc = document.createElement('div');
                    appDesc.className = 'app-desc';
                    appDesc.textContent = htmlEntityToEmoji(item.description || '暂无简介');

                    appInfo.appendChild(appName);
                    appInfo.appendChild(appDesc);
                    appItem.appendChild(appIcon);
                    appItem.appendChild(appInfo);
                    appList.appendChild(appItem);
                });
            } catch (error) {
                console.error('显示收藏记录失败:', error);
                showEmptyState('加载失败', '无法读取收藏记录');
            }
        }

        /**
         * 确认取消收藏
         * @param {string} appId 应用ID
         */
        function confirmRemoveCollection(appId) {
            if (window.plus) {
                // 使用5+ SDK的确认对话框
                plus.nativeUI.confirm('取消收藏吗？', function(res) {
                    if (res.index === 0) {
                        removeFromCollection(appId);
                    }
                }, '提示', ['确定', '取消']);
            } else {
                // 使用浏览器的确认对话框
                if (confirm('取消收藏吗？')) {
                    removeFromCollection(appId);
                }
            }
        }

        /**
         * 从收藏中移除应用
         * @param {string} appId 应用ID
         */
        function removeFromCollection(appId) {
            try {
                // 读取现有收藏
                let collection = JSON.parse(localStorage.getItem('appCollection') || '[]');
                
                // 过滤掉要移除的应用
                const newCollection = collection.filter(item => item.id !== appId);
                
                // 保存回本地存储
                localStorage.setItem('appCollection', JSON.stringify(newCollection));
                
                // 重新显示收藏记录
                showCollection();
                
                // 关闭操作菜单
                closeActionMenu();
                
                // 显示取消收藏成功提示
                if (window.plus) {
                    plus.nativeUI.toast('取消收藏成功');
                } else {
                    toast('取消收藏成功');
                }
            } catch (error) {
                console.error('取消收藏失败:', error);
                // 关闭操作菜单
                closeActionMenu();
                if (window.plus) {
                    plus.nativeUI.toast('取消收藏失败');
                } else {
                    toast('取消收藏失败');
                }
            }
        }

        /**
         * 确认删除用户分享的应用
         * @param {string} appId 应用ID
         */
        function confirmDeleteUserApp(appId) {
            if (window.plus) {
                // 使用5+ SDK的确认对话框
                plus.nativeUI.confirm('确定删除这个应用吗？', function(res) {
                    if (res.index === 0) {
                        deleteUserApp(appId);
                    }
                }, '提示', ['确定', '取消']);
            } else {
                // 使用浏览器的确认对话框
                if (confirm('确定删除这个应用吗？')) {
                    deleteUserApp(appId);
                }
            }
        }

        /**
         * 删除用户分享的应用
         * @param {string} appId 应用ID
         */
        async function deleteUserApp(appId) {
            const mail = localStorage.getItem('usermail');
            if (!mail) {
                toast('请先登录');
                closeActionMenu();
                return;
            }

            try {
                // 显示加载动画
                if (window.plus) {
                    plus.nativeUI.showWaiting('删除中...');
                }

                // 调用后端接口删除应用
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=delete_user_app&mail=${encodeURIComponent(mail)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: appId, mail: mail })
                });

                if (!response.ok) throw new Error('网络响应不正常');
                const res = await response.json();

                // 隐藏加载动画
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }

                if (res.code === 200) {
                    // 显示删除成功提示
                    if (window.plus) {
                        plus.nativeUI.toast('删除成功');
                    } else {
                        toast('删除成功');
                    }
                    
                    // 等待0.2秒后重新加载应用列表
                    setTimeout(function() {
                        getUserApps();
                    }, 200);
                } else {
                    // 显示删除失败提示
                    if (window.plus) {
                        plus.nativeUI.toast('删除失败');
                    } else {
                        toast('删除失败');
                    }
                }
            } catch (error) {
                console.error('删除应用失败:', error);
                
                // 隐藏加载动画
                if (window.plus) {
                    plus.nativeUI.closeWaiting();
                }
                
                // 显示错误提示
                if (window.plus) {
                    plus.nativeUI.toast('删除失败，请稍后重试');
                } else {
                    toast('删除失败，请稍后重试');
                }
            } finally {
                // 关闭操作菜单
                closeActionMenu();
            }
        }

        // 显示空状态
        function showEmptyState(title, desc) {
            const appList = document.querySelector('.app-list');
            if (!appList) return;

            appList.innerHTML = '';
            const emptyItem = document.createElement('div');
            emptyItem.className = 'app-item';

            const appIcon = document.createElement('div');
            appIcon.className = 'app-icon';

            const appInfo = document.createElement('div');
            appInfo.className = 'app-info';

            const appName = document.createElement('div');
            appName.className = 'app-name';
            appName.textContent = title;

            const appDesc = document.createElement('div');
            appDesc.className = 'app-desc';
            appDesc.textContent = desc;

            appInfo.appendChild(appName);
            appInfo.appendChild(appDesc);
            emptyItem.appendChild(appIcon);
            emptyItem.appendChild(appInfo);
            appList.appendChild(emptyItem);
        }

        // 获取用户分享的应用
        async function getUserApps() {
            const mail = localStorage.getItem('usermail');
            if (!mail) {
                showEmptyState('请先登录', '登录后查看您分享的应用');
                return;
            }

            // 显示加载动画
            const appList = document.querySelector('.app-list');
            if (appList) {
                appList.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">加载中...</div>
                    </div>
                `;
            }

            try {
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_user_apps&mail=${encodeURIComponent(mail)}`, {
                    method: 'GET'
                });
                const res = await response.json();
                if (res.code === 200 && res.fields) {
                    updateUserAppList(res.fields);
                } else if (res.code === 400 || res.code === 404) {
                    showEmptyState('请先登录', '登录后查看您分享的应用');
                } else if (res.code === 403) {
                    showEmptyState('账号环境异常', '请勿多端登录');
                } else {
                    showEmptyState('暂无分享记录', '您还没有分享过应用');
                }
            } catch (e) {
                console.error('Get User Apps Error:', e);
                showEmptyState('网络错误', '请稍后重试');
            }
        }

        // 更新用户应用列表
        function updateUserAppList(apps) {
            const appList = document.querySelector('.app-list');
            if (!appList) return;

            if (apps.length === 0) {
                showEmptyState('暂无分享记录', '您还没有分享过应用');
                return;
            }

            // 清空现有列表
            appList.innerHTML = '';

            // 添加新应用
                apps.forEach(app => {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item';
                    appItem.onclick = function() {
                        // 页面切换前设置为非活动状态
                        setPageInactive();
                        var url = 'xiangqing.html?id=' + app.id;
                        if (window.plus) {
                            var ws = plus.webview.create(url, url, {
                                backbuttonMaximize: false
                            });
                            ws.show('pop-in', 300);
                        } else {
                            window.location.href = url;
                        }
                    };

                    // 添加长按事件
                    addLongPressEvent(appItem, app, 'app');

                    const appIcon = document.createElement('div');
                    appIcon.className = 'app-icon';
                    if (app.图标) {
                        appIcon.style.background = `url('${app.图标}') center/cover`;
                    }

                    const appInfo = document.createElement('div');
                    appInfo.className = 'app-info';

                    const appName = document.createElement('div');
                    appName.className = 'app-name';
                    appName.textContent = htmlEntityToEmoji(app.名称 || '未知应用');

                    const appDesc = document.createElement('div');
                    appDesc.className = 'app-desc';
                    appDesc.textContent = htmlEntityToEmoji(app.简介 || '暂无简介');

                    appInfo.appendChild(appName);
                    appInfo.appendChild(appDesc);
                    appItem.appendChild(appIcon);
                    appItem.appendChild(appInfo);

                    // 添加应用状态徽章
                    const statusBadge = document.createElement('div');
                    statusBadge.className = 'status-badge';
                    
                    // 根据是否推荐字段设置状态
                    if (app.是否推荐 === '推荐') {
                        statusBadge.className += ' status-shared';
                        statusBadge.textContent = '已分享';
                    } else if (app.是否推荐 === '未通过') {
                        statusBadge.className += ' status-failed';
                        statusBadge.textContent = '未通过';
                    } else if (app.是否推荐 === '待审核') {
                        statusBadge.className += ' status-pending';
                        statusBadge.textContent = '待审核';
                    }
                    
                    // 只有当有状态时才添加
                    if (statusBadge.textContent) {
                        appItem.appendChild(statusBadge);
                    }
                    
                    appList.appendChild(appItem);
                });
        }

        function openHomePage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                // 直接关闭当前页面，返回上一页
                plus.webview.currentWebview().close('pop-out', 300);
            } else {
                window.history.back();
            }
        }

        function openRegisterPage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('zhuce.html', 'zhuce.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'zhuce.html';
            }
        }

        function openMessagePage() {
            // 立即隐藏未读消息徽章
            const badge = document.getElementById('unreadBadge');
            if (badge) {
                badge.style.display = 'none';
            }
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('xiaoxi.html', 'xiaoxi.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'xiaoxi.html';
            }
        }

        function openSettingPage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('setting.html', 'setting.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'setting.html';
            }
        }

        function openUserPage() {
            const mail = localStorage.getItem('usermail');
            if (!mail) {
                toast('请先登录');
                return;
            }
            // 页面切换前设置为非活动状态
            setPageInactive();
            var url = 'page.html?user=' + encodeURIComponent(mail);
            if (window.plus) {
                var ws = plus.webview.create(url, url, {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = url;
            }
        }

        // 获取未读消息数量
        async function getUnreadMessageCount() {
            const mail = localStorage.getItem('usermail');
            if (!mail) return;

            try {
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_messages&mail=${encodeURIComponent(mail)}`, {
                    method: 'GET'
                });
                const res = await response.json();
                if (res.code === 200 && res.fields) {
                    // 过滤出未读且未删除的消息
                    const unreadMessages = res.fields.filter(msg => 
                        msg['是否已读'] === '否' && msg['是否删除'] === '否'
                    );
                    // 更新未读消息数量显示
                    updateUnreadBadge(unreadMessages.length);
                }
            } catch (e) {
                console.error('Get Unread Messages Error:', e);
            }
        }

        // 更新未读消息数量显示
        function updateUnreadBadge(count) {
            const badge = document.getElementById('unreadBadge');
            if (!badge) return;

            if (count > 0) {
                badge.style.display = 'flex';
                badge.textContent = count > 99 ? '99+' : count;
            } else {
                badge.style.display = 'none';
            }
        }

        function openMallPage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('mall.html', 'mall.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'mall.html';
            }
        }

        function openSharePage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('share.html', 'share.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'share.html';
            }
        }

        function openReviewPage() {
            // 页面切换前设置为非活动状态
            setPageInactive();
            if (window.plus) {
                var ws = plus.webview.create('guanli.html', 'guanli.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'guanli.html';
            }
        }
    </script>
</body>

</html>

