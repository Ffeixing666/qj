<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>应用商店 - 首页</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent-blue: #007AFF;
            --control-bg: #E3E3E6;
            --header-item-height: 34px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            /* 禁用选中文本复制 */
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* 顶部导航 */
        header {
            position: sticky;
            top: 0;
            background-color: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(25px);
            z-index: 100;
            padding: 10px 16px;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tabs {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .tab-item {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.2, 1, 0.2, 1);
            line-height: 1;
        }

        .tab-item.active {
            font-size: 26px;
            color: var(--text-main);
        }

        .right-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-bar-fake {
            width: 110px;
            height: var(--header-item-height);
            background: var(--control-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .search-icon-img {
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        .msg-box {
            width: var(--header-item-height);
            height: var(--header-item-height);
            background: var(--control-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .msg-icon-img {
            width: 20px;
            height: 20px;
        }

        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            background: #FF3B30;
            color: white;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 4px rgba(255, 59, 48, 0.3);
        }

        /* 主体内容 */
        #app-content { display: block; }
        #web-content { display: none; }

        .featured-section { padding: 10px 16px; }
        .featured-card {
    width: 100%;
    height: 170px;
    background: url('https://creation.bcmcdn.com/716/appcraft/IMAGE_X7MYzrDXx_1771169472865.jpeg') center/cover no-repeat;
    border-radius: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.04);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    border: 0.5px solid rgba(255,255,255,0.8);
}

        .nav-scroll {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            gap: 22px;
            padding: 12px 16px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-item { font-size: 15px; color: var(--text-secondary); font-weight: 500; }
        .nav-item.active { color: var(--accent-blue); }

        .app-list { padding: 4px 16px 100px 16px; }
        .app-item {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            overflow: hidden; /* 防止溢出 */
        }
        .app-icon {
            flex-shrink: 0; /* 确保图标不被压缩 */
            width: 60px;
            height: 60px;
            background: #f0f0f2;
            border-radius: 14px;
            margin-right: 14px;
        }
        .app-info { 
            flex: 1; 
            min-width: 0; /* 关键：允许内容在Flex容器内正常截断 */
        }
        .app-name { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 简介限制一行并显示省略号 */
        .app-desc { 
            font-size: 12px; 
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1; /* 限制显示1行 */
            overflow: hidden;
            word-break: break-all;
        }

        /* --- 底部导航栏 --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 52px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding: 0;
        }

        .bottom-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #8E8E93;
            text-decoration: none;
            flex: 1;
            height: 100%;
            cursor: pointer;
        }

        .bottom-item.active { color: var(--accent-blue); }

        .nav-icon-img {
            width: 22px;
            height: 22px;
            margin-bottom: 2px;
        }

        .fab {
            position: fixed;
            right: 20px;
            bottom: 72px;
            width: 46px;
            height: 46px;
            background: rgba(255, 255, 255, 0.95);
            border: 0.5px solid rgba(0,0,0,0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 300;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 99;
        }

        .empty-state {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 50vh;
            color: var(--text-secondary);
            display: none;
        }

        /* 加载动画样式 */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            position: relative;
            margin-bottom: 16px;
        }

        .loading-spinner::before, .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            animation-delay: -0.5s;
            border-top-color: var(--text-secondary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <div class="tabs">
                <span class="tab-item active" onclick="switchTab('app')">应用</span>
                <span class="tab-item" onclick="switchTab('web')">网页</span>
            </div>
           
            <div class="right-controls">
                <div class="search-bar-fake" onclick="openSearchPage()">
                    <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_aS28drljD_1766889872494.png" class="search-icon-img" alt="">
                    <span>搜索</span>
                </div>
                <div class="msg-box" onclick="openMessagePage()">
                    <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_N7XqHo5QC_1766889837434.png" class="msg-icon-img" alt="">
                    <div class="unread-badge" id="unreadBadge" style="display: none;">0</div>
                </div>
            </div>
        </div>
    </header>

    <main id="app-content">
        <section class="featured-section">
            <div class="featured-card">
                <p style="font-weight: 500; letter-spacing: 1px;"></p>
            </div>
        </section>

        <nav class="nav-scroll">
            <span class="nav-item active" onclick="switchCategory('')">推荐</span>
            <span class="nav-item" onclick="switchCategory('latest')">最新</span>
            <span class="nav-item" onclick="switchCategory('rank')">排行</span>
            <span class="nav-item" onclick="switchCategory('影视音乐')">影视音乐</span>
            <span class="nav-item" onclick="switchCategory('实用工具')">实用工具</span>
            <span class="nav-item" onclick="switchCategory('娱乐游戏')">娱乐游戏</span>
            <span class="nav-item" onclick="switchCategory('学习必备')">学习必备</span>
            <span class="nav-item" onclick="switchCategory('社交生活')">社交生活</span>
        </nav>

        <section class="app-list">
            <div class="app-item">
                <div class="app-icon"></div>
                <div class="app-info">
                    <div class="app-name">加载中...</div>
                    <div class="app-desc">请稍候</div>
                </div>
            </div>
        </section>
    </main>

    <div id="web-content" class="empty-state">
        <h3 style="font-weight: 500; color: #1c1c1e;">卖力开发中</h3>
        <p style="font-size: 13px; margin-top: 6px;">正在连接更广阔的世界</p>
    </div>

    <div class="fab" onclick="openSharePage()">+</div>

    <nav class="bottom-nav">
        <div class="bottom-item active">
            <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_W4dgFlZKZZ_1766889744282.png" class="nav-icon-img" alt="首页">
            <span>首页</span>
        </div>
        <div onclick="openMePage()" class="bottom-item">
            <img src="https://creation.bcmcdn.com/716/appcraft/IMAGE_mjBXhTQOaY_1766889744283.png" class="nav-icon-img" alt="我的">
            <span>我的</span>
        </div>
    </nav>

    <script>
        // 万能返回键逻辑
        document.addEventListener('plusready', function() {
            var webview = plus.webview.currentWebview();
            plus.key.addEventListener('backbutton', function() {
                webview.canBack(function(e) {
                    if (e.canBack) {
                        webview.back();
                    } else {
                        var path = window.location.pathname;
                        var isHomePage = path.indexOf('home.html') !== -1 || path === '/' || path.indexOf('index.html') !== -1;
                        if (isHomePage) {
                            plus.nativeUI.confirm("确定退出应用吗？", function(res) {
                                if (res.index === 0) plus.runtime.quit();
                            }, "提示", ["确定", "取消"]);
                        } else {
                            if (plus.webview.all().length > 1) {
                                webview.close('auto'); 
                            } else {
                                history.back();
                            }
                        }
                    }
                });
            });
        });

        function switchTab(type) {
            const tabs = document.querySelectorAll('.tab-item');
            const app = document.getElementById('app-content');
            const web = document.getElementById('web-content');

            if (type === 'app') {
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                app.style.display = 'block';
                web.style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                tabs[0].classList.remove('active');
                app.style.display = 'none';
                web.style.display = 'flex';
            }
        }

        function openSearchPage() {
            if (window.plus) {
                var ws = plus.webview.create('search.html', 'search.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'search.html';
            }
        }

        // 切换分类
        function switchCategory(filter) {
            // 更新标签状态
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 获取应用列表
            getApps(filter);
        }

        async function getApps(filter = '', retryCount = 0) {
            const mail = localStorage.getItem('usermail');
            if (!mail) {
                showLoginPrompt();
                return;
            }

            // 显示加载动画
            const appList = document.querySelector('.app-list');
            if (appList) {
                appList.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">加载中...</div>
                    </div>
                `;
            }

            try {
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_app_list&mail=${encodeURIComponent(mail)}&filter=${encodeURIComponent(filter)}`, {
                    method: 'GET'
                });
                const res = await response.json();
                if (res.code === 200 && res.fields) {
                    updateAppList(res.fields);
                } else if (res.code === 400 || res.code === 404) {
                    showLoginPrompt();
                } else if (res.code === 403) {
                    showErrorPrompt(res.msg || '账号环境异常，请勿多端登录');
                }
            } catch (e) {
                console.error('Get Apps Error:', e);
                // 检查是否有用户数据且未超过重试次数
                if (mail && retryCount < 1) {
                    console.log('网络请求失败，检查到用户数据，正在重试...');
                    // 延迟1秒后重试，避免请求过于频繁
                    setTimeout(() => {
                        getApps(filter, retryCount + 1);
                    }, 1000);
                    return;
                }
                // 加载失败时显示错误信息
                if (appList) {
                    appList.innerHTML = `
                        <div class="app-item" style="justify-content: center;">
                            <div class="app-info" style="text-align: center;">
                                <div class="app-name">加载失败</div>
                                <div class="app-desc">网络连接异常，请稍后重试</div>
                            </div>
                        </div>
                    `;
                }
            } finally {
                // 应用处理完成后，获取未读消息数量
                getUnreadMessageCount();
            }
        }

        function showLoginPrompt() {
            const appList = document.querySelector('.app-list');
            if (!appList) return;
            
            const loginItem = document.createElement('div');
            loginItem.className = 'app-item';
            loginItem.style.justifyContent = 'center';
            loginItem.style.cursor = 'pointer';
            
            loginItem.innerHTML = `
                <div class="app-info" style="text-align: center;">
                    <div class="app-name">请先登录</div>
                    <div class="app-desc">登录一下连接更广阔的世界</div>
                </div>
            `;
            
            loginItem.onclick = function() {
                if (window.plus) {
                    var ws = plus.webview.create('me.html', 'me.html', {
                        backbuttonMaximize: false
                    });
                    ws.show('pop-in', 300);
                } else {
                    window.location.href = 'me.html';
                }
            };
            
            appList.innerHTML = '';
            appList.appendChild(loginItem);
        }

        function showErrorPrompt(message) {
            const appList = document.querySelector('.app-list');
            if (!appList) return;
            appList.innerHTML = `
                <div class="app-item" style="justify-content: center;">
                    <div class="app-info" style="text-align: center;">
                        <div class="app-name">访问受限</div>
                        <div class="app-desc">${message}</div>
                    </div>
                </div>`;
        }

        function updateAppList(apps) {
            const appList = document.querySelector('.app-list');
            if (!appList) return;
            appList.innerHTML = '';

            apps.forEach(app => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                appItem.onclick = function() {
                    var url = 'xiangqing.html?id=' + app.id;
                    if (window.plus) {
                        var ws = plus.webview.create(url, url, {
                            backbuttonMaximize: false
                        });
                        ws.show('pop-in', 300);
                    } else {
                        window.location.href = url;
                    }
                };

                const iconStyle = app.图标 ? `style="background: url('${app.图标}') center/cover"` : "";
                
                appItem.innerHTML = `
                    <div class="app-icon" ${iconStyle}></div>
                    <div class="app-info">
                        <div class="app-name">${app.名称 || '未知应用'}</div>
                        <div class="app-desc">${app.简介 || '暂无简介'}</div>
                    </div>
                `;
                appList.appendChild(appItem);
            });
        }

        function openMePage() {
            if (window.plus) {
                var ws = plus.webview.create('me.html', 'me.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'me.html';
            }
        }

        function openSharePage() {
            if (window.plus) {
                var ws = plus.webview.create('share.html', 'share.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'share.html';
            }
        }

        function openMessagePage() {
            // 立即隐藏未读消息徽章
            const badge = document.getElementById('unreadBadge');
            if (badge) {
                badge.style.display = 'none';
            }
            if (window.plus) {
                var ws = plus.webview.create('xiaoxi.html', 'xiaoxi.html', {
                    backbuttonMaximize: false
                });
                ws.show('pop-in', 300);
            } else {
                window.location.href = 'xiaoxi.html';
            }
        }

        // 获取未读消息数量
        async function getUnreadMessageCount() {
            const mail = localStorage.getItem('usermail');
            if (!mail) return;

            try {
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=get_messages&mail=${encodeURIComponent(mail)}`, {
                    method: 'GET'
                });
                const res = await response.json();
                if (res.code === 200 && res.fields) {
                    // 过滤出未读且未删除的消息
                    const unreadMessages = res.fields.filter(msg => 
                        msg['是否已读'] === '否' && msg['是否删除'] === '否'
                    );
                    // 更新未读消息数量显示
                    updateUnreadBadge(unreadMessages.length);
                }
            } catch (e) {
                console.error('Get Unread Messages Error:', e);
            }
        }

        // 更新未读消息数量显示
        function updateUnreadBadge(count) {
            const badge = document.getElementById('unreadBadge');
            if (!badge) return;

            if (count > 0) {
                badge.style.display = 'flex';
                badge.textContent = count > 99 ? '99+' : count;
            } else {
                badge.style.display = 'none';
            }
        }

        window.onload = function() {
            // 添加0.5秒延迟再请求应用数据
            setTimeout(function() {
                getApps();
            }, 500);
        };
    </script>
</body>

</html>

