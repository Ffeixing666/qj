<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>用户注册 - 趣加应用</title>
    <script src="https://static2.pgaot.com/Assets/js/jquery-2.2.4.min.js"></script>
    <style>
        :root { --primary: #007AFF; }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none;
            user-select: none;
        }
        body { background: #F2F2F7; font-family: -apple-system, sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { width: 90%; max-width: 400px; background: #fff; border-radius: 24px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .step { display: none; }
        .active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #e5e5ea; border-radius: 12px; background: #f9f9fb; outline: none; box-sizing: border-box; font-size: 16px; -webkit-user-select: text; user-select: text; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #toast { position: fixed; top: 20px; background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; display: none; font-size: 14px; z-index: 9999; }
    </style>
</head>
<body>
<div id="toast"></div>
<div class="card">
    <h2 style="text-align:center; margin-bottom: 20px;">Welcome</h2>
    
    <div id="s1" class="step active">
        <input type="email" id="email" placeholder="输入邮箱地址">
        <button class="btn" onclick="goStep1()">发送验证码</button>
    </div>

    <div id="s2" class="step">
        <p style="font-size:13px; color:#888;">验证码已发送至邮箱</p>
        <input type="number" id="vcode" placeholder="4位验证码" pattern="\d*">
        <button class="btn" onclick="goStep2()">校验验证码</button>
    </div>

    <div id="s3" class="step">
        <input type="text" id="nick" placeholder="用户昵称">
        <input type="password" id="p1" placeholder="设置密码">
        <input type="password" id="p2" placeholder="确认密码">
        <button id="regBtn" class="btn" onclick="goStep3()">完成注册</button>
    </div>
</div>

<script>
    const API = 'https://apirank.qujiaweb.top/';
    // 初始化 cache 确保 code 为空字符串
    let cache = { email: '', code: '' };

    function toast(m) { $('#toast').text(m).stop(true, true).fadeIn().delay(2000).fadeOut(); }

    function showStep(n) { $('.step').removeClass('active'); $(`#s${n}`).addClass('active'); }

    // 步骤 1: 发送验证码
    async function goStep1() {
        const email = $('#email').val().trim();
        if(!email.includes('@')) return toast('请输入有效邮箱');
        
        // 1. 先生成验证码并存入 cache
        const generatedCode = Math.floor(1000 + Math.random() * 9000).toString();
        cache.code = generatedCode;
        cache.email = email;

        toast('正在发送验证码...');
        
        try {
            const mail = await fetch(`${API}?mode=send_mail`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to: email, code: generatedCode })
            }).then(r => r.json());

            console.log('发送反馈:', mail);

            if(mail.code === 200) { 
                showStep(2); 
                toast('验证码已发送'); 
            } else { 
                toast('发送失败：' + (mail.msg || '服务商拦截'));
            }
        } catch(e) { 
            console.error(e);
            toast('网络繁忙，请稍后再试'); 
        }
    }

    // 步骤 2: 校验验证码 (修复对比逻辑)
    function goStep2() {
        const inputCode = $('#vcode').val().trim();
        
        console.log('用户输入:', inputCode, '缓存验证码:', cache.code);
        
        // 使用双等号或强制转字符串对比，防止类型不匹配
        if(inputCode && inputCode.toString() === cache.code.toString()) {
            showStep(3);
        } else {
            toast('验证码错误');
        }
    }

    // 检查密码是否包含特殊字符
    function hasSpecialChars(password) {
        // 只允许字母、数字和下划线
        return !/^[a-zA-Z0-9_]+$/.test(password);
    }

    // 转义emoji字符
    function escapeEmoji(text) {
        return [...text].map(char => {
            const code = char.codePointAt(0);
            if (
                (code >= 0x1F300 && code <= 0x1F6FF) ||
                (code >= 0x1F900 && code <= 0x1F9FF) ||
                (code >= 0x1FA70 && code <= 0x1FAFF) ||
                (code >= 0x2600 && code <= 0x26FF) ||
                (code >= 0x2700 && code <= 0x27BF) ||
                (code >= 0x1F1E6 && code <= 0x1F1FF)
            ) {
                return `&#${code};`;
            } else {
                return char;
            }
        }).join('').replace(/'/g, "~PGDBSD~");
    }

    // 步骤 3: 注册提交
    async function goStep3() {
        const nick = $('#nick').val().trim();
        const p1 = $('#p1').val();
        const p2 = $('#p2').val();

        if(!nick) return toast('请输入昵称');
        if(p1.length < 6) return toast('密码至少6位');
        if(p1 !== p2) return toast('两次输入的密码不一致');
        if(hasSpecialChars(p1)) return toast('密码请勿包含特殊字符');

        // 转义emoji字符
        const escapedNick = escapeEmoji(nick);

        // --- 修改部分：禁用按钮防止重复点击 ---
        const $btn = $('#regBtn');
        $btn.prop('disabled', true).text('提交中...');
        // ------------------------------------

        toast('正在完成注册...');
        try {
            const res = await fetch(`${API}?mode=register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: cache.email, 
                    password: p1, 
                    nickname: escapedNick 
                })
            }).then(r => r.json());

            if(res.code === 200) {
                toast('注册成功！');
                setTimeout(() => {
                    location.href = 'index.html'; 
                }, 1500);
            } else {
                toast('提交失败：' + (res.msg || '接口错误'));
                // 失败时恢复按钮
                $btn.prop('disabled', false).text('完成注册');
            }
        } catch(e) { 
            toast('提交出错，请稍后重试'); 
            // 异常时恢复按钮
            $btn.prop('disabled', false).text('完成注册');
        }
    }

    // 返回键处理
    document.addEventListener('plusready', function() {
        var webview = plus.webview.currentWebview();
        plus.key.addEventListener('backbutton', function() {
            webview.canBack(function(e) {
                if (e.canBack) {
                    webview.back();
                } else {
                    var path = window.location.pathname;
                    if (path.indexOf('index.html') !== -1) {
                        plus.nativeUI.confirm("确定退出应用吗？", function(res) {
                            if (res.index === 0) plus.runtime.quit();
                        }, "提示", ["确定", "取消"]);
                    } else {
                        webview.close('pop-out', 300);
                    }
                }
            });
        });
    });
</script>
</body>
</html>
