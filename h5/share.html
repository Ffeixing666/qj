<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>分享应用</title>
    <script src="https://cdn.jsdelivr.net/npm/app-info-parser@1.1.4/dist/app-info-parser.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --text-main: #1C1C1E;
            --text-second: #8E8E93;
            --line-color: rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-main);
            padding-bottom: 60px;
        }

        header {
            position: sticky; top: 0; z-index: 100;
            background-color: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--line-color);
        }
        .nav-bar { height: 48px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
        .back-btn { width: 40px; height: 100%; display: flex; align-items: center; }
        .back-icon { width: 11px; height: 11px; border-left: 2px solid var(--ios-blue); border-bottom: 2px solid var(--ios-blue); transform: rotate(45deg); }
        .nav-title { font-size: 17px; font-weight: 600; }

        .container { padding: 16px; max-width: 600px; margin: 0 auto; }

        /* 上传卡片 - 初始显示 */
        #upload-zone {
            background: var(--ios-card);
            border: 1.5px dashed #C7C7CC;
            border-radius: 16px;
            padding: 40px 16px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        #upload-zone svg { width: 48px; height: 48px; fill: var(--ios-blue); margin-bottom: 12px; }
        #upload-zone h4 { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        #upload-zone p { font-size: 13px; color: var(--text-second); }

        /* 解析状态 */
        #status-tip { text-align: center; color: var(--ios-blue); font-size: 14px; margin-top: 20px; display: none; }

        /* 后续表单区域 - 初始隐藏 */
        #content-step { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-card { background: var(--ios-card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 16px; }
        .app-header { display: flex; align-items: center; gap: 16px; padding-bottom: 16px; border-bottom: 0.5px solid var(--line-color); margin-bottom: 16px; }
        #app-icon { width: 68px; height: 68px; border-radius: 14px; background: #F2F2F7; object-fit: cover; border: 0.5px solid var(--line-color); }
        .name-area h2 { font-size: 19px; font-weight: 700; margin-bottom: 4px; }
        .name-area code { font-size: 12px; color: var(--ios-blue); opacity: 0.8; word-break: break-all; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { background: #F8F8FA; padding: 12px; border-radius: 10px; }
        .info-label { font-size: 11px; color: var(--text-second); margin-bottom: 4px; display: block; }
        .info-value { font-size: 13px; font-weight: 600; }

        /* 截图管理 */
        .section-header { font-size: 14px; font-weight: 600; color: var(--text-second); margin: 20px 0 10px 4px; display: flex; justify-content: space-between; }
        .screenshot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ss-box { aspect-ratio: 9/16; background: #E5E5EA; border-radius: 10px; position: relative; overflow: hidden; border: 0.5px solid var(--line-color); }
        .ss-box img { width: 100%; height: 100%; object-fit: cover; }
        .ss-del { position: absolute; top: 6px; right: 6px; width: 22px; height: 22px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; }
        
        .ss-add { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1.5px dashed #C7C7CC; background: transparent; color: var(--text-second); cursor: pointer; }
        .ss-add svg { width: 24px; height: 24px; fill: var(--text-second); }

        /* 上传加载动画 */
        .loading-spinner {
            width: 24px; height: 24px;
            border: 2px solid rgba(0,122,255,0.2);
            border-top: 2px solid var(--ios-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 网盘区域 */
        #pan-section { display: none; background: #FFF9F2; border: 0.5px solid #FFE5CC; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .pan-header { display: flex; align-items: center; gap: 6px; color: var(--ios-orange); font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .pan-header svg { width: 16px; height: 16px; fill: var(--ios-orange); }

        .ios-input-group { background: var(--ios-card); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
        .ios-item { display: flex; align-items: center; padding: 12px 16px; position: relative; }
        .ios-item:not(:last-child)::after { content: ""; position: absolute; bottom: 0; left: 16px; right: 0; height: 0.5px; background: var(--line-color); }
        .ios-item input, .ios-item textarea { width: 100%; border: none; outline: none; font-size: 15px; background: transparent; font-family: inherit; }
        .ios-item textarea { height: 100px; padding: 4px 0; resize: none; }

        .submit-btn { width: 100%; height: 52px; background: var(--ios-blue); color: #fff; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        .submit-btn:active { opacity: 0.8; transform: scale(0.99); }

        /* 分类选择器 */
        .category-section { margin: 20px 0; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .category-item { padding: 12px; border: 1.5px solid var(--line-color); border-radius: 10px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .category-item.active { background: var(--ios-blue); color: #fff; border-color: var(--ios-blue); }
        .category-item:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <header>
        <div class="nav-bar">
            <div class="back-btn" onclick="handleBack()"><div class="back-icon"></div></div>
            <div class="nav-title">应用分享</div>
            <div style="width:40px"></div>
        </div>
    </header>

    <main class="container">
        <div id="upload-zone" onclick="document.getElementById('apkInput').click()">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
            <h4>点击上传</h4>
            <p>请选择本地的APK安装包</p>
            <input type="file" id="apkInput" style="display:none">
        </div>

        <div id="status-tip">加载中…</div>

        <div id="content-step">
            <div class="result-card">
                <div class="app-header">
                    <img id="app-icon" src="">
                    <div class="name-area">
                        <h2 id="app-name">-</h2>
                        <code id="app-pkg">-</h2>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">应用版本</span><span class="info-value" id="v-text">-</span></div>
                    <div class="info-item"><span class="info-label">应用大小</span><span class="info-value" id="s-text">-</span></div>
                    <div class="info-item"><span class="info-label">安卓版本</span><span class="info-value" id="sdk-text">-</span></div>
                    <div class="info-item"><span class="info-label">系统位数</span><span class="info-value" id="arch-text">-</span></div>
                </div>
            </div>

            <div id="pan-section">
                <div class="pan-header">
                    <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                    <span>应用超过100M，仅支持网盘分享</span>
                </div>
                <div class="ios-input-group">
                    <div class="ios-item"><input type="text" id="pan-url" placeholder="网盘链接 (必填)"></div>
                    <div class="ios-item"><input type="text" id="pan-pwd" placeholder="提取密码 (选填)"></div>
                </div>
            </div>

            <div class="section-header"><span>应用截图</span><span id="ss-count" style="font-weight:400; font-size:12px;">至少1张</span></div>
            <div class="screenshot-grid" id="ss-grid">
                <div class="ss-box ss-add" id="ss-trigger" onclick="document.getElementById('ssFile').click()">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </div>
            </div>
            <input type="file" id="ssFile" accept="image/*" style="display:none" multiple>

            <div class="section-header">应用分类</div>
            <div class="category-section">
                <div class="category-grid">
                    <div class="category-item" onclick="selectCategory(this, '影视音乐')">影视音乐</div>
                    <div class="category-item" onclick="selectCategory(this, '实用工具')">实用工具</div>
                    <div class="category-item" onclick="selectCategory(this, '娱乐游戏')">娱乐游戏</div>
                    <div class="category-item" onclick="selectCategory(this, '学习必备')">学习必备</div>
                    <div class="category-item" onclick="selectCategory(this, '社交生活')">社交生活</div>
                </div>
            </div>

            <div class="section-header">应用简介</div>
            <div class="ios-input-group">
                <div class="ios-item"><textarea id="app-intro" placeholder="请输入应用的相关介绍..."></textarea></div>
            </div>

            <button class="submit-btn" onclick="finalSubmit()">立即分享</button>
        </div>
    </main>

    <script>
        const SDK_MAP = { 19: "4.4", 21: "5.0", 22: "5.1", 23: "6.0", 24: "7.0", 25: "7.1", 26: "8.0", 27: "8.1", 28: "9.0", 29: "10", 30: "11", 31: "12", 32: "12L", 33: "13", 34: "14", 35: "15" };
        let screenshots = [];
        let apkInfo = null;
        let selectedCategory = null;
        let uploadedApkUrl = null;
        let uploadedIconUrl = null;

        // --- 保险的 SDK 搜索逻辑 ---
        function findMinSdk(obj) {
            if (!obj) return null;
            if (obj.minSdkVersion) return obj.minSdkVersion;
            const manifest = obj.manifest || obj;
            if (manifest['uses-sdk']) {
                const sdkInfo = Array.isArray(manifest['uses-sdk']) ? manifest['uses-sdk'][0] : manifest['uses-sdk'];
                return sdkInfo['@android:minSdkVersion'] || sdkInfo['minSdkVersion'] || sdkInfo['android:minSdkVersion'];
            }
            let found = null;
            for (let key in obj) {
                if (key.toLowerCase().includes('minsdkversion')) return obj[key];
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    found = findMinSdk(obj[key]);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- APK 上传与解析 ---
        document.getElementById('apkInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const tip = document.getElementById('status-tip');
            tip.style.display = 'block';

            try {
                const parser = new AppInfoParser(file);
                const info = await parser.parse();
                
                // 1. 处理名称
                let finalName = info.name;
                
                // 优先寻找中文名称
                if (info.application && info.application.label) {
                    if (Array.isArray(info.application.label)) {
                        // 遍历数组，寻找包含中文字符的名称
                        for (let label of info.application.label) {
                            if (/[\u4e00-\u9fa5]/.test(label)) {
                                finalName = label;
                                break;
                            }
                        }
                        // 如果没有找到中文名称，使用第一个名称
                        if (!finalName) {
                            finalName = info.application.label[0];
                        }
                    } else {
                        finalName = info.application.label;
                    }
                }
                
                if (!finalName || String(finalName).startsWith('@')) finalName = info.package;

                // 2. 处理 SDK
                const rawSdk = findMinSdk(info);
                const androidVer = SDK_MAP[rawSdk] || "未知";

                // 3. 处理架构
                const zip = await JSZip.loadAsync(file);
                const archs = new Set();
                Object.keys(zip.files).forEach(p => { if (p.startsWith('lib/')) { const parts = p.split('/'); if (parts.length > 2) archs.add(parts[1]); } });
                const archArray = Array.from(archs);
                let bitDisplay = "全架构兼容";
                if (archArray.length > 0) {
                    const is64 = archArray.some(a => a.includes('64'));
                    const is32 = archArray.some(a => a.includes('v7a') || a === 'armeabi');
                    bitDisplay = (is64 && is32) ? "32/64位兼容" : (is64 ? "纯64位" : "纯32位");
                }

                // 4. 渲染基本信息
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                document.getElementById('app-icon').src = info.icon || '';
                document.getElementById('app-name').innerText = finalName;
                document.getElementById('app-pkg').innerText = info.package;
                document.getElementById('v-text').innerText = info.versionName;
                document.getElementById('s-text').innerText = sizeMB + " MB";
                document.getElementById('sdk-text').innerText = "Android " + androidVer + "+";
                document.getElementById('arch-text').innerText = bitDisplay;

                // 5. 处理APK上传（小于100MB）
                let appLink = '';
                if (parseFloat(sizeMB) <= 100) {
                    // 上传APK到对象存储
                    appLink = await uploadApk(file);
                } else {
                    // 大于100MB，显示网盘链接输入
                    document.getElementById('pan-section').style.display = 'block';
                }

                // 6. 上传图标到对象存储
                if (info.icon) {
                    await uploadIcon(info.icon);
                }

                // 核心逻辑：隐藏上传框，显示表单
                document.getElementById('upload-zone').style.display = 'none';
                tip.style.display = 'none';
                document.getElementById('content-step').style.display = 'block';
                apkInfo = { 
                    finalName, 
                    sizeMB, 
                    package: info.package, 
                    versionName: info.versionName, 
                    androidVer, 
                    bitDisplay, 
                    appLink 
                };

            } catch (err) {
                tip.innerText = "解析失败，请检查文件是否损坏";
                console.error('解析错误:', err);
            }
        };

        // --- 图片上传逻辑 ---
        document.getElementById('ssFile').onchange = async (e) => {
            const files = Array.from(e.target.files);
            const trigger = document.getElementById('ss-trigger');
            
            for (let file of files) {
                // 显示加载状态
                trigger.innerHTML = '<div class="loading-spinner"></div>';
                
                const fd = new FormData();
                fd.append('file', file);
                try {
                    const res = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', { method: 'POST', body: fd });
                    const data = await res.json();
                    const url = data.full_url || data.url;
                    if (url) screenshots.push(url);
                } catch (err) { console.error(err); }
            }
            
            // 恢复并渲染
            trigger.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
            renderScreens();
        };

        function renderScreens() {
            const grid = document.getElementById('ss-grid');
            const trigger = document.getElementById('ss-trigger');
            const items = document.querySelectorAll('.ss-item-node');
            items.forEach(el => el.remove());

            screenshots.forEach((url, i) => {
                const div = document.createElement('div');
                div.className = 'ss-box ss-item-node';
                div.innerHTML = `<img src="${url}"><div class="ss-del" onclick="removeSS(${i})">✕</div>`;
                grid.insertBefore(div, trigger);
            });
            document.getElementById('ss-count').innerText = `已上传 ${screenshots.length} 张`;
        }

        function removeSS(i) {
            screenshots.splice(i, 1);
            renderScreens();
        }

        // 完整的数据提交逻辑
        async function finalSubmit() {
            // 验证必填字段
            if (screenshots.length < 1) {
                showToast('请至少上传一张截图');
                return;
            }

            if (!selectedCategory) {
                showToast('请选择应用分类');
                return;
            }

            const intro = document.getElementById('app-intro').value;
            if (!intro) {
                showToast('请输入应用简介');
                return;
            }

            if (intro.length < 5) {
                showToast('应用简介至少需要5个字');
                return;
            }

            // 获取用户信息（从本地存储）
            const userMail = localStorage.getItem('usermail') || '';
            const userName = localStorage.getItem('username') || '';

            if (!userMail || !userName) {
                showToast('请先登录');
                return;
            }

            // 处理应用链接
            let appLink = apkInfo.appLink;
            let password = '';
            if (parseFloat(apkInfo.sizeMB) > 100) {
                // 大于100MB，使用网盘链接
                appLink = document.getElementById('pan-url').value;
                password = document.getElementById('pan-pwd').value;
                if (!appLink) {
                    showToast('请输入网盘链接');
                    return;
                }
            }

            // 构建请求数据
            const requestData = {
                name: apkInfo.finalName,
                link: appLink,
                icon: uploadedIconUrl,
                intro: processIntro(intro),
                images: screenshots.join(','),
                is_recommended: '待审核',
                password: password,
                user: userName,
                mail: userMail,
                category: selectedCategory,
                package_name: apkInfo.package,
                version: apkInfo.versionName,
                size: Math.floor(parseFloat(apkInfo.sizeMB)) + ' MB',
                arch: apkInfo.bitDisplay,
                android_version: apkInfo.androidVer + '+'
            };
            
            // 打印请求数据以便调试
            console.log('发送的请求数据:', requestData);

            // 显示加载状态
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = '提交中...';
            submitBtn.disabled = true;

            try {
                // 发送请求到后端API
                console.log('开始发送请求到后端...');
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=add_app&mail=${encodeURIComponent(userMail)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('响应状态:', response.status);
                const result = await response.json();
                console.log('后端返回结果:', result);
                
                if (result.code === 200) {
                    showToast('应用分享成功！');
                    // 延迟返回
                    setTimeout(() => {
                        handleBack();
                    }, 1500);
                } else {
                    showToast('提交失败：' + (result.msg || '未知错误'));
                }
            } catch (error) {
                showToast('网络错误，请重试');
                console.error('提交错误:', error);
            } finally {
                // 恢复按钮状态
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        }

        // 轻提示函数
        function showToast(message) {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                animation: fadeInOut 2s ease-in-out;
            `;
            toast.innerText = message;

            // 添加动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; }
                    20% { opacity: 1; }
                    80% { opacity: 1; }
                    100% { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // 添加到页面
            document.body.appendChild(toast);

            // 2秒后移除
            setTimeout(() => {
                document.body.removeChild(toast);
                document.head.removeChild(style);
            }, 2000);
        }

        // 分类选择函数
        function selectCategory(element, category) {
            // 移除所有active类
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            // 添加active类到当前选择
            element.classList.add('active');
            selectedCategory = category;
        }

        // APK上传到对象存储（带进度条）
        function uploadApk(file) {
            return new Promise((resolve, reject) => {
                const tip = document.getElementById('status-tip');
                tip.innerText = '应用上传中...';
                tip.style.display = 'block';

                // 创建进度条
                const progressBar = document.createElement('div');
                progressBar.style.cssText = `
                    width: 80%;
                    height: 6px;
                    background: #E5E5EA;
                    border-radius: 3px;
                    margin: 10px auto;
                    overflow: hidden;
                `;
                
                const progressFill = document.createElement('div');
                progressFill.style.cssText = `
                    width: 0%;
                    height: 100%;
                    background: var(--ios-blue);
                    border-radius: 3px;
                    transition: width 0.3s ease;
                `;
                
                progressBar.appendChild(progressFill);
                tip.parentNode.insertBefore(progressBar, tip.nextSibling);

                // 使用XMLHttpRequest以支持上传进度
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                formData.append('file', file);

                xhr.open('POST', 'https://apirank.qujiaweb.top/?mode=upload_meituan');

                // 添加进度监听
                xhr.upload.addEventListener('progress', function(progressEvent) {
                    if (progressEvent.lengthComputable) {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressFill.style.width = percentCompleted + '%';
                    }
                });

                // 处理响应
                xhr.onload = function() {
                    // 移除进度条
                    progressBar.remove();
                    
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            if (result.full_url) {
                                uploadedApkUrl = result.full_url;
                                tip.innerText = '应用已上传至服务器，请等待';
                                resolve(result.full_url);
                            } else {
                                tip.innerText = '应用上传失败，请重试';
                                reject(new Error('APK上传失败'));
                            }
                        } catch (e) {
                            tip.innerText = '应用上传失败，请重试';
                            reject(new Error('响应解析失败'));
                        }
                    } else {
                        tip.innerText = '应用上传失败，请重试';
                        reject(new Error('上传请求失败'));
                    }
                };

                // 处理错误
                xhr.onerror = function() {
                    // 移除进度条
                    progressBar.remove();
                    tip.innerText = '应用上传失败，请重试';
                    reject(new Error('网络错误'));
                };

                // 发送请求
                xhr.send(formData);
            });
        }

        // 图标上传到对象存储
        async function uploadIcon(iconData) {
            try {
                // 将base64图标转换为Blob
                const response = await fetch(iconData);
                const blob = await response.blob();
                const file = new File([blob], 'app_icon.png', { type: 'image/png' });

                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', {
                    method: 'POST',
                    body: formData
                });

                const result = await uploadResponse.json();
                if (result.full_url) {
                    uploadedIconUrl = result.full_url;
                    return result.full_url;
                } else {
                    throw new Error('图标上传失败');
                }
            } catch (error) {
                console.error('图标上传失败:', error);
                throw error;
            }
        }

        // emoji转HTML实体函数
        function emojiToHtmlEntity(str) {
            return [...str].map(char => {
                const code = char.codePointAt(0);
                if (
                    (code >= 0x1F300 && code <= 0x1F6FF) ||
                    (code >= 0x1F900 && code <= 0x1F9FF) ||
                    (code >= 0x1FA70 && code <= 0x1FAFF) ||
                    (code >= 0x2600 && code <= 0x26FF) ||
                    (code >= 0x2700 && code <= 0x27BF) ||
                    (code >= 0x1F1E6 && code <= 0x1F1FF)
                ) {
                    return `&#${code};`;
                } else {
                    return char;
                }
            }).join('');
        }

        // 处理简介中的emoji和引号
        function processIntro(intro) {
            // 将emoji转换为HTML实体
            let processed = emojiToHtmlEntity(intro);
            // 转义单引号和双引号
            processed = processed.replace(/'/g, "'").replace(/"/g, '"');
            return processed;
        }

        function handleBack() {
            if (window.plus) {
                plus.webview.currentWebview().close('auto');
            } else {
                window.history.back();
            }
        }

        document.addEventListener('plusready', function() {
            var webview = plus.webview.currentWebview();

            plus.key.addEventListener('backbutton', function() {
                webview.canBack(function(e) {
                    if (e.canBack) {
                        webview.back();
                    } else {
                        var path = window.location.pathname;
                        // 这里识别为非首页，执行关闭逻辑
                        var isHomePage = path.indexOf('index.html') !== -1 && path.indexOf('app/') === -1;

                        if (isHomePage) {
                            plus.nativeUI.confirm("确定退出应用吗？", function(res) {
                                if (res.index === 0) plus.runtime.quit();
                            }, "提示", ["确定", "取消"]);
                        } else {
                            // 子页面：直接关闭，返回首页
                            if (plus.webview.all().length > 1) {
                                webview.close('auto'); 
                            } else {
                                history.back();
                            }
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>