<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>分享应用</title>
    <script>
    (function() {
        const scripts = [
            { src: 'js/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'js/jszip.min.js', lib: 'JSZip' },
            { src: 'https://cdn.bytedance.com/?url=https://cdn.jsdelivr.net/npm/app-info-parser@1.1.4/dist/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'https://cdn.bytedance.com/?url=https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', lib: 'JSZip' }
        ];
        const libMap = new Map();
        scripts.forEach(item => {
            if (!libMap.has(item.lib)) libMap.set(item.lib, []);
            libMap.get(item.lib).push(item.src);
        });
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve(src);
                script.onerror = () => reject(src);
                document.head.appendChild(script);
            });
        }
        async function loadAllScripts() {
            for (let [libName, srcList] of libMap.entries()) {
                let loaded = false;
                for (let src of srcList) {
                    try { await loadScript(src); loaded = true; break; } catch (e) { continue; }
                }
                if (!loaded) console.error(`无法加载库: ${libName}`);
            }
        }
        loadAllScripts();
    })();
    </script>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --ios-blue: #007AFF; --ios-orange: #FF9500; --text-main: #1C1C1E; --text-second: #8E8E93; --line-color: rgba(0,0,0,0.06); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); color: var(--text-main); padding-bottom: 60px; }
        header { position: sticky; top: 0; z-index: 100; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 0.5px solid var(--line-color); }
        .nav-bar { height: 48px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
        .back-icon { width: 11px; height: 11px; border-left: 2px solid var(--ios-blue); border-bottom: 2px solid var(--ios-blue); transform: rotate(45deg); }
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        #upload-zone { background: var(--ios-card); border: 1.5px dashed #C7C7CC; border-radius: 16px; padding: 40px 16px; text-align: center; cursor: pointer; margin-bottom:16px; }
        #backup-upload { background: var(--ios-card); border: 1.5px dashed var(--ios-orange); border-radius: 16px; padding: 30px 16px; text-align: center; cursor: pointer; }
        #status-tip { text-align: center; color: var(--ios-blue); font-size: 14px; margin-top: 20px; display: none; }
        #content-step { display: none; }
        .result-card { background: var(--ios-card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 16px; }
        .app-header { display: flex; align-items: center; gap: 16px; padding-bottom: 16px; border-bottom: 0.5px solid var(--line-color); margin-bottom: 16px; }
        #app-icon { width: 68px; height: 68px; border-radius: 14px; background: #F2F2F7; object-fit: cover; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { background: #F8F8FA; padding: 12px; border-radius: 10px; }
        .info-label { font-size: 11px; color: var(--text-second); display: block; }
        .info-value { font-size: 13px; font-weight: 600; }
        .screenshot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ss-box { aspect-ratio: 9/16; background: #E5E5EA; border-radius: 10px; position: relative; overflow: hidden; }
        .ss-box img { width: 100%; height: 100%; object-fit: cover; }
        .ss-add { display: flex; border: 1.5px dashed #C7C7CC; cursor: pointer; justify-content: center; align-items: center; }
        .ios-input-group { background: var(--ios-card); border-radius: 12px; overflow: hidden; margin-bottom: 16px; border: 0.5px solid var(--line-color); }
        .ios-item { padding: 12px 16px; border-bottom: 0.5px solid var(--line-color); }
        .ios-item input, .ios-item textarea { width: 100%; border: none; outline: none; font-size: 15px; background: transparent; }
        .submit-btn { width: 100%; height: 52px; background: var(--ios-blue); color: #fff; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; margin-top: 10px; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .category-item { padding: 12px; border: 1.5px solid var(--line-color); border-radius: 10px; text-align: center; font-size: 13px; cursor: pointer; }
        .category-item.active { background: var(--ios-blue); color: #fff; border-color: var(--ios-blue); }
    </style>
</head>
<body>
    <header><div class="nav-bar"><div onclick="closeSelf()" style="width:40px"><div class="back-icon"></div></div><div class="nav-title">应用分享</div><div style="width:40px"></div></div></header>

    <main class="container">
        <div id="upload-zone" onclick="document.getElementById('apkInput').click()">
            <h4>标准上传</h4><p>常规浏览器方式选择 APK</p>
            <input type="file" id="apkInput" style="display:none">
        </div>

        <div id="backup-upload" onclick="pickFileWithSDK()">
            <h4 style="color: var(--ios-orange);">备用上传（原生模式）</h4>
            <p>专门解决华为/鸿蒙“解析失败”问题</p>
        </div>

        <div id="status-tip">解析中...</div>

        <div id="content-step">
            <div class="result-card">
                <div class="app-header">
                    <img id="app-icon" src=""><div class="name-area">
                        <input type="text" id="app-name" style="font-size:18px;font-weight:700;border:none;outline:none;width:100%" placeholder="应用名称">
                        <div id="app-pkg" style="font-size:11px;color:var(--ios-blue)">-</div>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">版本</span><span class="info-value" id="v-text">-</span></div>
                    <div class="info-item"><span class="info-label">大小</span><span class="info-value" id="s-text">-</span></div>
                </div>
            </div>

            <div id="pan-section" style="display:none; padding:12px; background:#FFF9F2; border-radius:10px; margin-bottom:15px; border:0.5px solid #FF9500;">
                <p style="font-size:12px; color:#FF9500; margin-bottom:8px;">⚠️ 文件较大，请填写网盘链接：</p>
                <div class="ios-input-group" style="margin-bottom:0">
                    <div class="ios-item"><input type="text" id="pan-url" placeholder="网盘链接"></div>
                    <div class="ios-item"><input type="text" id="pan-pwd" placeholder="提取码"></div>
                </div>
            </div>

            <div class="screenshot-grid" id="ss-grid">
                <div class="ss-box ss-add" id="ss-trigger" onclick="document.getElementById('ssFile').click()">+</div>
            </div>
            <input type="file" id="ssFile" accept="image/*" style="display:none" multiple>

            <div class="category-grid">
                <div class="category-item" onclick="selectCat(this, '实用工具')">实用工具</div>
                <div class="category-item" onclick="selectCat(this, '影视音乐')">影视音乐</div>
                <div class="category-item" onclick="selectCat(this, '娱乐游戏')">娱乐游戏</div>
            </div>

            <div class="ios-input-group" style="margin-top:15px">
                <div class="ios-item"><textarea id="app-intro" placeholder="简介..." rows="4"></textarea></div>
            </div>
            <button class="submit-btn" onclick="finalSubmit()">发布分享</button>
        </div>
    </main>

    <script>
        let apkInfo = null, screenshots = [], selectedCategory = '', uploadedIconUrl = '';

        // --- 核心修复：原生文件选择与路径处理 ---
        function pickFileWithSDK() {
            if (!window.plus) return alert('请在手机App内使用');
            
            const main = plus.android.runtimeMainActivity();
            const Intent = plus.android.importClass('android.content.Intent');
            const intent = new Intent(Intent.ACTION_GET_CONTENT);
            intent.setType("application/vnd.android.package-archive");
            intent.addCategory(Intent.CATEGORY_OPENABLE);

            main.onActivityResult = function(requestCode, resultCode, data) {
                if (requestCode === 1002 && data) {
                    const uri = data.getData();
                    if (uri) {
                        copyAndProcessFile(uri);
                    }
                }
            };
            main.startActivityForResult(intent, 1002);
        }

        function copyAndProcessFile(uri) {
            const tip = document.getElementById('status-tip');
            tip.style.display = 'block';
            tip.innerText = "正在读取文件...";

            try {
                const main = plus.android.runtimeMainActivity();
                const contentResolver = main.getContentResolver();
                
                // 1. 导入必要的原生类
                plus.android.importClass(contentResolver);
                const inputStream = contentResolver.openInputStream(uri);
                plus.android.importClass(inputStream);

                // 2. 创建本地临时文件路径
                const tempFileName = "temp_" + Date.now() + ".apk";
                const tempPath = plus.io.convertLocalFileSystemURL("_doc/" + tempFileName);
                
                const FileOutputStream = plus.android.importClass('java.io.FileOutputStream');
                const outStream = new FileOutputStream(tempPath);

                // 3. 缓冲区读取写入
                const buffer = plus.android.newObject('byte[]', 1024 * 16);
                let bytesRead;
                while ((bytesRead = inputStream.read(buffer)) !== -1) {
                    outStream.write(buffer, 0, bytesRead);
                }
                outStream.close();
                inputStream.close();

                // 4. 将本地文件转为 Web Blob
                plus.io.resolveLocalFileSystemURL("_doc/" + tempFileName, (entry) => {
                    entry.file((file) => {
                        const reader = new plus.io.FileReader();
                        reader.onloadend = (e) => {
                            const blob = new Blob([e.target.result], { type: 'application/vnd.android.package-archive' });
                            const stdFile = new File([blob], tempFileName, { type: 'application/vnd.android.package-archive' });
                            handleApkFile(stdFile);
                        };
                        reader.readAsArrayBuffer(file);
                    });
                }, (err) => { alert("本地映射失败"); });

            } catch (e) {
                console.error(e);
                alert("原生流读取出错: " + e.message);
            }
        }

        async function handleApkFile(file) {
            const tip = document.getElementById('status-tip');
            tip.style.display = 'block';
            tip.innerText = '正在解析 APK 内部信息...';

            try {
                const parser = new AppInfoParser(file);
                const info = await parser.parse();
                
                // 提取信息
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                document.getElementById('app-icon').src = info.icon || '';
                document.getElementById('app-name').value = info.name || info.package;
                document.getElementById('app-pkg').innerText = info.package;
                document.getElementById('v-text').innerText = info.versionName;
                document.getElementById('s-text').innerText = sizeMB + " MB";

                apkInfo = { ...info, sizeMB, appLink: '' };
                if (parseFloat(sizeMB) > 100) document.getElementById('pan-section').style.display = 'block';

                // 上传
                if (info.icon) uploadIcon(info.icon);
                if (parseFloat(sizeMB) <= 100) await uploadApk(file);

                document.getElementById('upload-zone').style.display = 'none';
                document.getElementById('backup-upload').style.display = 'none';
                tip.style.display = 'none';
                document.getElementById('content-step').style.display = 'block';
            } catch (err) {
                tip.innerText = "解析失败: " + err.message;
            }
        }

        async function uploadApk(file) {
            const fd = new FormData();
            fd.append('file', file);
            try {
                const res = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.full_url) apkInfo.appLink = data.full_url;
            } catch (e) {}
        }

        async function uploadIcon(base64) {
            const res = await fetch(base64);
            const blob = await res.blob();
            const fd = new FormData();
            fd.append('file', blob, 'icon.png');
            const up = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', { method: 'POST', body: fd });
            const data = await up.json();
            uploadedIconUrl = data.full_url;
        }

        document.getElementById('apkInput').onchange = (e) => {
            if (e.target.files[0]) handleApkFile(e.target.files[0]);
        };

        document.getElementById('ssFile').onchange = async (e) => {
            for (let f of e.target.files) {
                const fd = new FormData();
                fd.append('file', f);
                const r = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', { method: 'POST', body: fd });
                const d = await r.json();
                if (d.full_url) {
                    screenshots.push(d.full_url);
                    const div = document.createElement('div');
                    div.className = 'ss-box';
                    div.innerHTML = `<img src="${d.full_url}">`;
                    document.getElementById('ss-grid').insertBefore(div, document.getElementById('ss-trigger'));
                }
            }
        };

        function selectCat(el, c) {
            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            selectedCategory = c;
        }

        async function finalSubmit() {
            const name = document.getElementById('app-name').value;
            const intro = document.getElementById('app-intro').value;
            const mail = localStorage.getItem('usermail');
            if (!name || !selectedCategory) return alert("请完善必填项");

            const payload = {
                name: name,
                link: apkInfo.appLink || document.getElementById('pan-url').value,
                password: document.getElementById('pan-pwd').value,
                icon: uploadedIconUrl,
                images: screenshots.join(','),
                intro: intro,
                category: selectedCategory,
                user: localStorage.getItem('username'),
                mail: mail,
                package_name: apkInfo.package,
                version: apkInfo.versionName,
                size: apkInfo.sizeMB + " MB"
            };

            await fetch(`https://apirank.qujiaweb.top/?mode=add_app&mail=${mail}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            alert("提交成功");
            closeSelf();
        }

        function closeSelf() {
            if (window.plus) plus.webview.currentWebview().close('auto');
            else window.history.back();
        }
    </script>
</body>
</html>
