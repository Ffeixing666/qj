<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†äº«åº”ç”¨</title>
    <!-- æ”¾åœ¨ head æˆ– body å¼€å¤´ä½ç½®ï¼Œæ›¿æ¢åŸæœ‰çš„ä¸¤ä¸ª script æ ‡ç­¾ -->
    <script>
    (function() {
        // å®šä¹‰éœ€è¦åŠ è½½çš„è„šæœ¬åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        const scripts = [
            // 1. é¦–é€‰ï¼šæœ¬åœ°ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚æœä½ ä¸‹è½½äº†æ–‡ä»¶æ”¾åˆ° js æ–‡ä»¶å¤¹ï¼‰
            { src: 'js/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'js/jszip.min.js', lib: 'JSZip' },
            
            // 2. å¤‡é€‰1ï¼šå­—èŠ‚è·³åŠ¨åä»£ï¼ˆå›½å†…é€šå¸¸å¾ˆå¿«ï¼‰
            { src: 'https://cdn.bytedance.com/?url=https://cdn.jsdelivr.net/npm/app-info-parser@1.1.4/dist/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'https://cdn.bytedance.com/?url=https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', lib: 'JSZip' },
            
            // 3. å¤‡é€‰2ï¼šåŸå§‹ jsDelivrï¼ˆå›½é™…é€šç”¨ï¼‰
            { src: 'https://cdn.jsdelivr.net/npm/app-info-parser@1.1.4/dist/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', lib: 'JSZip' },
            
            // 4. å¤‡é€‰3ï¼šUNPKGï¼ˆå¦ä¸€ä¸ªå¸¸ç”¨ CDNï¼‰
            { src: 'https://unpkg.com/app-info-parser@1.1.4/dist/app-info-parser.js', lib: 'AppInfoParser' },
            { src: 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js', lib: 'JSZip' }
        ];

        // å»é‡å¹¶æŒ‰åº“åˆ†ç»„
        const libMap = new Map();
        scripts.forEach(item => {
            if (!libMap.has(item.lib)) libMap.set(item.lib, []);
            libMap.get(item.lib).push(item.src);
        });

        // åŠ è½½å•ä¸ªè„šæœ¬ï¼Œè¿”å› Promise
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve(src);
                script.onerror = () => reject(src);
                document.head.appendChild(script);
            });
        }

        // æŒ‰é¡ºåºå°è¯•åŠ è½½æ‰€æœ‰è„šæœ¬
        async function loadAllScripts() {
            const errors = [];
            
            for (let [libName, srcList] of libMap.entries()) {
                let loaded = false;
                
                for (let src of srcList) {
                    try {
                        console.log(`å°è¯•åŠ è½½ ${libName} ä»: ${src}`);
                        await loadScript(src);
                        console.log(`âœ… ${libName} åŠ è½½æˆåŠŸ: ${src}`);
                        loaded = true;
                        break; // æˆåŠŸåè·³å‡ºå†…å±‚å¾ªç¯
                    } catch (e) {
                        console.warn(`âŒ ${libName} åŠ è½½å¤±è´¥: ${src}`);
                        errors.push(src);
                    }
                }
                
                if (!loaded) {
                    throw new Error(`æ— æ³•åŠ è½½åº“: ${libName}ï¼Œæ‰€æœ‰ CDN å‡å¤±è´¥`);
                }
            }
            
            console.log('ğŸ‰ æ‰€æœ‰ä¾èµ–åº“åŠ è½½å®Œæˆï¼');
        }

        // æ‰§è¡ŒåŠ è½½ï¼Œå¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
        loadAllScripts().catch(error => {
            console.error('è„šæœ¬åŠ è½½å¤±è´¥:', error);
            // åœ¨é¡µé¢æ˜¾ç¤ºå‹å¥½æç¤º
            const tip = document.createElement('div');
            tip.style.cssText = 'position:fixed; top:0; left:0; right:0; background:#ff3b30; color:white; padding:12px; text-align:center; z-index:9999; font-size:14px;';
            tip.innerText = 'ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ— æ³•åŠ è½½å¿…è¦ç»„ä»¶ã€‚è¯·åˆ·æ–°é‡è¯•æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒã€‚';
            document.body.prepend(tip);
        });
    })();
    </script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --text-main: #1C1C1E;
            --text-second: #8E8E93;
            --line-color: rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-main);
            padding-bottom: 60px;
        }

        header {
            position: sticky; top: 0; z-index: 100;
            background-color: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--line-color);
        }
        .nav-bar { height: 48px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
        .back-btn { width: 40px; height: 100%; display: flex; align-items: center; }
        .back-icon { width: 11px; height: 11px; border-left: 2px solid var(--ios-blue); border-bottom: 2px solid var(--ios-blue); transform: rotate(45deg); }
        .nav-title { font-size: 17px; font-weight: 600; }

        .container { padding: 16px; max-width: 600px; margin: 0 auto; }

        /* ä¸Šä¼ å¡ç‰‡ - åˆå§‹æ˜¾ç¤º */
        #upload-zone {
            background: var(--ios-card);
            border: 1.5px dashed #C7C7CC;
            border-radius: 16px;
            padding: 40px 16px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        #upload-zone svg { width: 48px; height: 48px; fill: var(--ios-blue); margin-bottom: 12px; }
        #upload-zone h4 { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        #upload-zone p { font-size: 13px; color: var(--text-second); }

        /* è§£æçŠ¶æ€ */
        #status-tip { text-align: center; color: var(--ios-blue); font-size: 14px; margin-top: 20px; display: none; }

        /* åç»­è¡¨å•åŒºåŸŸ - åˆå§‹éšè— */
        #content-step { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-card { background: var(--ios-card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 16px; }
        .app-header { display: flex; align-items: center; gap: 16px; padding-bottom: 16px; border-bottom: 0.5px solid var(--line-color); margin-bottom: 16px; }
        #app-icon { width: 68px; height: 68px; border-radius: 14px; background: #F2F2F7; object-fit: cover; border: 0.5px solid var(--line-color); }
        .name-area .app-name-input { 
            font-size: 19px; 
            font-weight: 700; 
            margin-bottom: 4px; 
            border: none; 
            outline: none; 
            background: transparent; 
            font-family: inherit; 
            color: var(--text-main); 
            width: 100%; 
        }
        .name-area code { font-size: 12px; color: var(--ios-blue); opacity: 0.8; word-break: break-all; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { background: #F8F8FA; padding: 12px; border-radius: 10px; }
        .info-label { font-size: 11px; color: var(--text-second); margin-bottom: 4px; display: block; }
        .info-value { font-size: 13px; font-weight: 600; }

        /* æˆªå›¾ç®¡ç† */
        .section-header { font-size: 14px; font-weight: 600; color: var(--text-second); margin: 20px 0 10px 4px; display: flex; justify-content: space-between; }
        .screenshot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ss-box { aspect-ratio: 9/16; background: #E5E5EA; border-radius: 10px; position: relative; overflow: hidden; border: 0.5px solid var(--line-color); }
        .ss-box img { width: 100%; height: 100%; object-fit: cover; }
        .ss-del { position: absolute; top: 6px; right: 6px; width: 22px; height: 22px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; }
        
        .ss-add { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1.5px dashed #C7C7CC; background: transparent; color: var(--text-second); cursor: pointer; }
        .ss-add svg { width: 24px; height: 24px; fill: var(--text-second); }

        /* ä¸Šä¼ åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 24px; height: 24px;
            border: 2px solid rgba(0,122,255,0.2);
            border-top: 2px solid var(--ios-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ç½‘ç›˜åŒºåŸŸ */
        #pan-section { display: none; background: #FFF9F2; border: 0.5px solid #FFE5CC; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .pan-header { display: flex; align-items: center; gap: 6px; color: var(--ios-orange); font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .pan-header svg { width: 16px; height: 16px; fill: var(--ios-orange); }

        .ios-input-group { background: var(--ios-card); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
        .ios-item { display: flex; align-items: center; padding: 12px 16px; position: relative; }
        .ios-item:not(:last-child)::after { content: ""; position: absolute; bottom: 0; left: 16px; right: 0; height: 0.5px; background: var(--line-color); }
        .ios-item input, .ios-item textarea { width: 100%; border: none; outline: none; font-size: 15px; background: transparent; font-family: inherit; }
        .ios-item textarea { height: 100px; padding: 4px 0; resize: none; }

        .submit-btn { width: 100%; height: 52px; background: var(--ios-blue); color: #fff; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        .submit-btn:active { opacity: 0.8; transform: scale(0.99); }

        /* åˆ†ç±»é€‰æ‹©å™¨ */
        .category-section { margin: 20px 0; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .category-item { padding: 12px; border: 1.5px solid var(--line-color); border-radius: 10px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .category-item.active { background: var(--ios-blue); color: #fff; border-color: var(--ios-blue); }
        .category-item:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <header>
        <div class="nav-bar">
            <div class="back-btn" onclick="closeSelf()"><div class="back-icon"></div></div>
            <div class="nav-title">åº”ç”¨åˆ†äº«</div>
            <div style="width:40px"></div>
        </div>
    </header>

    <main class="container">
        <div id="upload-zone" onclick="document.getElementById('apkInput').click()">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
            <h4>ç‚¹å‡»ä¸Šä¼ </h4>
            <p>è¯·é€‰æ‹©æœ¬åœ°çš„APKå®‰è£…åŒ…</p>
            <input type="file" id="apkInput" style="display:none">
        </div>

        <!-- å¤‡ç”¨ä¸Šä¼ é€‰é¡¹ -->
        <div id="backup-upload" onclick="pickFileWithSDK()" style="margin-top: 16px; background: var(--ios-card); border: 1.5px dashed #C7C7CC; border-radius: 16px; padding: 30px 16px; text-align: center; transition: all 0.2s; cursor: pointer;">
            <svg viewBox="0 0 24 24" style="width: 40px; height: 40px; fill: var(--ios-orange); margin-bottom: 10px;"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">å¤‡ç”¨ä¸Šä¼ </h4>
            <p style="font-size: 12px; color: var(--text-second);">ä½¿ç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨</p>
        </div>

        <div id="status-tip">åŠ è½½ä¸­â€¦</div>

        <div id="content-step">
            <div class="result-card">
                <div class="app-header">
                    <img id="app-icon" src="">
                    <div class="name-area">
                        <input type="text" id="app-name" class="app-name-input" placeholder="åº”ç”¨åç§°">
                        <code id="app-pkg">-</code>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">åº”ç”¨ç‰ˆæœ¬</span><span class="info-value" id="v-text">-</span></div>
                    <div class="info-item"><span class="info-label">åº”ç”¨å¤§å°</span><span class="info-value" id="s-text">-</span></div>
                    <div class="info-item"><span class="info-label">å®‰å“ç‰ˆæœ¬</span><span class="info-value" id="sdk-text">-</span></div>
                    <div class="info-item"><span class="info-label">ç³»ç»Ÿä½æ•°</span><span class="info-value" id="arch-text">-</span></div>
                </div>
            </div>

            <div id="pan-section">
                <div class="pan-header">
                    <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                    <span>åº”ç”¨è¶…è¿‡100Mï¼Œä»…æ”¯æŒç½‘ç›˜åˆ†äº«</span>
                </div>
                <div class="ios-input-group">
                    <div class="ios-item"><input type="text" id="pan-url" placeholder="ç½‘ç›˜é“¾æ¥ (å¿…å¡«)"></div>
                    <div class="ios-item"><input type="text" id="pan-pwd" placeholder="æå–å¯†ç  (é€‰å¡«)"></div>
                </div>
            </div>

            <div class="section-header"><span>åº”ç”¨æˆªå›¾</span><span id="ss-count" style="font-weight:400; font-size:12px;">è‡³å°‘1å¼ </span></div>
            <div class="screenshot-grid" id="ss-grid">
                <div class="ss-box ss-add" id="ss-trigger" onclick="document.getElementById('ssFile').click()">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </div>
            </div>
            <input type="file" id="ssFile" accept="image/*" style="display:none" multiple>

            <div class="section-header">åº”ç”¨åˆ†ç±»</div>
            <div class="category-section">
                <div class="category-grid">
                    <div class="category-item" onclick="selectCategory(this, 'å½±è§†éŸ³ä¹')">å½±è§†éŸ³ä¹</div>
                    <div class="category-item" onclick="selectCategory(this, 'å®ç”¨å·¥å…·')">å®ç”¨å·¥å…·</div>
                    <div class="category-item" onclick="selectCategory(this, 'å¨±ä¹æ¸¸æˆ')">å¨±ä¹æ¸¸æˆ</div>
                    <div class="category-item" onclick="selectCategory(this, 'å­¦ä¹ å¿…å¤‡')">å­¦ä¹ å¿…å¤‡</div>
                    <div class="category-item" onclick="selectCategory(this, 'ç¤¾äº¤ç”Ÿæ´»')">ç¤¾äº¤ç”Ÿæ´»</div>
                </div>
            </div>

            <div class="section-header">åº”ç”¨ç®€ä»‹</div>
            <div class="ios-input-group">
                <div class="ios-item"><textarea id="app-intro" placeholder="è¯·è¾“å…¥åº”ç”¨çš„ç›¸å…³ä»‹ç»..."></textarea></div>
            </div>

            <button class="submit-btn" onclick="finalSubmit()">ç«‹å³åˆ†äº«</button>
        </div>
    </main>

    <script>
        const SDK_MAP = { 19: "4.4", 21: "5.0", 22: "5.1", 23: "6.0", 24: "7.0", 25: "7.1", 26: "8.0", 27: "8.1", 28: "9.0", 29: "10", 30: "11", 31: "12", 32: "12L", 33: "13", 34: "14", 35: "15" };
        let screenshots = [];
        let apkInfo = null;
        let selectedCategory = null;
        let uploadedApkUrl = null;
        let uploadedIconUrl = null;

        // --- ä¿é™©çš„ SDK æœç´¢é€»è¾‘ ---
        function findMinSdk(obj) {
            if (!obj) return null;
            if (obj.minSdkVersion) return obj.minSdkVersion;
            const manifest = obj.manifest || obj;
            if (manifest['uses-sdk']) {
                const sdkInfo = Array.isArray(manifest['uses-sdk']) ? manifest['uses-sdk'][0] : manifest['uses-sdk'];
                return sdkInfo['@android:minSdkVersion'] || sdkInfo['minSdkVersion'] || sdkInfo['android:minSdkVersion'];
            }
            let found = null;
            for (let key in obj) {
                if (key.toLowerCase().includes('minsdkversion')) return obj[key];
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    found = findMinSdk(obj[key]);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- APK ä¸Šä¼ ä¸è§£æ ---
        document.getElementById('apkInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // è°ƒç”¨ç»Ÿä¸€çš„æ–‡ä»¶å¤„ç†å‡½æ•°
            handleApkFile(file);
        };

        // --- å›¾ç‰‡ä¸Šä¼ é€»è¾‘ ---
        document.getElementById('ssFile').onchange = async (e) => {
            const files = Array.from(e.target.files);
            const trigger = document.getElementById('ss-trigger');
            
            for (let file of files) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                trigger.innerHTML = '<div class="loading-spinner"></div>';
                
                const fd = new FormData();
                fd.append('file', file);
                try {
                    const res = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', { method: 'POST', body: fd });
                    const data = await res.json();
                    const url = data.full_url || data.url;
                    if (url) screenshots.push(url);
                } catch (err) { console.error(err); }
            }
            
            // æ¢å¤å¹¶æ¸²æŸ“
            trigger.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
            renderScreens();
        };

        function renderScreens() {
            const grid = document.getElementById('ss-grid');
            const trigger = document.getElementById('ss-trigger');
            const items = document.querySelectorAll('.ss-item-node');
            items.forEach(el => el.remove());

            screenshots.forEach((url, i) => {
                const div = document.createElement('div');
                div.className = 'ss-box ss-item-node';
                div.innerHTML = `<img src="${url}"><div class="ss-del" onclick="removeSS(${i})">âœ•</div>`;
                grid.insertBefore(div, trigger);
            });
            document.getElementById('ss-count').innerText = `å·²ä¸Šä¼  ${screenshots.length} å¼ `;
        }

        function removeSS(i) {
            screenshots.splice(i, 1);
            renderScreens();
        }

        // å®Œæ•´çš„æ•°æ®æäº¤é€»è¾‘
        async function finalSubmit() {
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (screenshots.length < 1) {
                showToast('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ æˆªå›¾');
                return;
            }

            if (!selectedCategory) {
                showToast('è¯·é€‰æ‹©åº”ç”¨åˆ†ç±»');
                return;
            }

            const intro = document.getElementById('app-intro').value;
            if (!intro) {
                showToast('è¯·è¾“å…¥åº”ç”¨ç®€ä»‹');
                return;
            }

            if (intro.length < 5) {
                showToast('åº”ç”¨ç®€ä»‹è‡³å°‘éœ€è¦5ä¸ªå­—');
                return;
            }

            // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»æœ¬åœ°å­˜å‚¨ï¼‰
            const userMail = localStorage.getItem('usermail') || '';
            const userName = localStorage.getItem('username') || '';

            if (!userMail || !userName) {
                showToast('è¯·å…ˆç™»å½•');
                return;
            }

            // å¤„ç†åº”ç”¨é“¾æ¥
            let appLink = apkInfo.appLink;
            let password = '';
            if (parseFloat(apkInfo.sizeMB) > 100) {
                // å¤§äº100MBï¼Œä½¿ç”¨ç½‘ç›˜é“¾æ¥
                appLink = document.getElementById('pan-url').value;
                password = document.getElementById('pan-pwd').value;
                if (!appLink) {
                    showToast('è¯·è¾“å…¥ç½‘ç›˜é“¾æ¥');
                    return;
                }
            }

            // è·å–åº”ç”¨åç§°ï¼ˆä»è¾“å…¥æ¡†ï¼‰
            const appName = document.getElementById('app-name').value.trim();
            if (!appName) {
                showToast('è¯·è¾“å…¥åº”ç”¨åç§°');
                return;
            }

            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                name: appName,
                link: appLink,
                icon: uploadedIconUrl,
                intro: processIntro(intro),
                images: screenshots.join(','),
                is_recommended: 'å¾…å®¡æ ¸',
                password: password,
                user: userName,
                mail: userMail,
                category: selectedCategory,
                package_name: apkInfo.package,
                version: apkInfo.versionName,
                size: Math.floor(parseFloat(apkInfo.sizeMB)) + ' MB',
                arch: apkInfo.bitDisplay,
                android_version: apkInfo.androidVer + '+'
            };
            
            // æ‰“å°è¯·æ±‚æ•°æ®ä»¥ä¾¿è°ƒè¯•
            console.log('å‘é€çš„è¯·æ±‚æ•°æ®:', requestData);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = 'æäº¤ä¸­...';
            submitBtn.disabled = true;

            try {
                // å‘é€è¯·æ±‚åˆ°åç«¯API
                console.log('å¼€å§‹å‘é€è¯·æ±‚åˆ°åç«¯...');
                const response = await fetch(`https://apirank.qujiaweb.top/?mode=add_app&mail=${encodeURIComponent(userMail)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                const result = await response.json();
                console.log('åç«¯è¿”å›ç»“æœ:', result);
                
                if (result.code === 200) {
                    showToast('åº”ç”¨åˆ†äº«æˆåŠŸï¼');
                    // å»¶è¿Ÿè¿”å›
                    setTimeout(() => {
                        closeSelf();
                    }, 1500);
                } else {
                    showToast('æäº¤å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                console.error('æäº¤é”™è¯¯:', error);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        }

        // è½»æç¤ºå‡½æ•°
        function showToast(message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                animation: fadeInOut 2s ease-in-out;
            `;
            toast.innerText = message;

            // æ·»åŠ åŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; }
                    20% { opacity: 1; }
                    80% { opacity: 1; }
                    100% { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // 2ç§’åç§»é™¤
            setTimeout(() => {
                document.body.removeChild(toast);
                document.head.removeChild(style);
            }, 2000);
        }

        // åˆ†ç±»é€‰æ‹©å‡½æ•°
        function selectCategory(element, category) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            // æ·»åŠ activeç±»åˆ°å½“å‰é€‰æ‹©
            element.classList.add('active');
            selectedCategory = category;
        }

        // APKä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
        function uploadApk(file) {
            return new Promise((resolve, reject) => {
                const tip = document.getElementById('status-tip');
                tip.innerText = 'åº”ç”¨ä¸Šä¼ ä¸­...';
                tip.style.display = 'block';

                // åˆ›å»ºè¿›åº¦æ¡
                const progressBar = document.createElement('div');
                progressBar.style.cssText = `
                    width: 80%;
                    height: 6px;
                    background: #E5E5EA;
                    border-radius: 3px;
                    margin: 10px auto;
                    overflow: hidden;
                `;
                
                const progressFill = document.createElement('div');
                progressFill.style.cssText = `
                    width: 0%;
                    height: 100%;
                    background: var(--ios-blue);
                    border-radius: 3px;
                    transition: width 0.3s ease;
                `;
                
                progressBar.appendChild(progressFill);
                tip.parentNode.insertBefore(progressBar, tip.nextSibling);

                // ä½¿ç”¨XMLHttpRequestä»¥æ”¯æŒä¸Šä¼ è¿›åº¦
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                formData.append('file', file);

                xhr.open('POST', 'https://apirank.qujiaweb.top/?mode=upload_meituan');

                // æ·»åŠ è¿›åº¦ç›‘å¬
                xhr.upload.addEventListener('progress', function(progressEvent) {
                    if (progressEvent.lengthComputable) {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressFill.style.width = percentCompleted + '%';
                    }
                });

                // å¤„ç†å“åº”
                xhr.onload = function() {
                    // ç§»é™¤è¿›åº¦æ¡
                    progressBar.remove();
                    
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            if (result.full_url) {
                                uploadedApkUrl = result.full_url;
                                tip.innerText = 'åº”ç”¨å·²ä¸Šä¼ è‡³æœåŠ¡å™¨ï¼Œè¯·ç­‰å¾…';
                                resolve(result.full_url);
                            } else {
                                tip.innerText = 'åº”ç”¨ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                                reject(new Error('APKä¸Šä¼ å¤±è´¥'));
                            }
                        } catch (e) {
                            tip.innerText = 'åº”ç”¨ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                            reject(new Error('å“åº”è§£æå¤±è´¥'));
                        }
                    } else {
                        tip.innerText = 'åº”ç”¨ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                        reject(new Error('ä¸Šä¼ è¯·æ±‚å¤±è´¥'));
                    }
                };

                // å¤„ç†é”™è¯¯
                xhr.onerror = function() {
                    // ç§»é™¤è¿›åº¦æ¡
                    progressBar.remove();
                    tip.innerText = 'åº”ç”¨ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                    reject(new Error('ç½‘ç»œé”™è¯¯'));
                };

                // å‘é€è¯·æ±‚
                xhr.send(formData);
            });
        }

        // å›¾æ ‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
        async function uploadIcon(iconData) {
            try {
                // å°†base64å›¾æ ‡è½¬æ¢ä¸ºBlob
                const response = await fetch(iconData);
                const blob = await response.blob();
                const file = new File([blob], 'app_icon.png', { type: 'image/png' });

                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('https://apirank.qujiaweb.top/?mode=upload_meituan', {
                    method: 'POST',
                    body: formData
                });

                const result = await uploadResponse.json();
                if (result.full_url) {
                    uploadedIconUrl = result.full_url;
                    return result.full_url;
                } else {
                    throw new Error('å›¾æ ‡ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('å›¾æ ‡ä¸Šä¼ å¤±è´¥:', error);
                throw error;
            }
        }

        // emojiè½¬HTMLå®ä½“å‡½æ•°
        function emojiToHtmlEntity(str) {
            return [...str].map(char => {
                const code = char.codePointAt(0);
                if (
                    (code >= 0x1F300 && code <= 0x1F6FF) ||
                    (code >= 0x1F900 && code <= 0x1F9FF) ||
                    (code >= 0x1FA70 && code <= 0x1FAFF) ||
                    (code >= 0x2600 && code <= 0x26FF) ||
                    (code >= 0x2700 && code <= 0x27BF) ||
                    (code >= 0x1F1E6 && code <= 0x1F1FF)
                ) {
                    return `&#${code};`;
                } else {
                    return char;
                }
            }).join('');
        }

        // å¤„ç†ç®€ä»‹ä¸­çš„emojiå’Œå¼•å·
        function processIntro(intro) {
            // å°†emojiè½¬æ¢ä¸ºHTMLå®ä½“
            let processed = emojiToHtmlEntity(intro);
            // è½¬ä¹‰å•å¼•å·å’ŒåŒå¼•å·
            processed = processed.replace(/'/g, "'").replace(/"/g, '"');
            return processed;
        }

        // å¤‡ç”¨ä¸Šä¼ å‡½æ•° - ä½¿ç”¨ 5+ SDK åŸç”Ÿæ–‡ä»¶é€‰æ‹©å™¨
        function pickFileWithSDK() {
            if (!window.plus) {
                showToast('è¯·åœ¨åº”ç”¨å†…ä½¿ç”¨æ­¤åŠŸèƒ½');
                return;
            }

            // å°è¯•ä½¿ç”¨ 5+ SDK çš„æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
            try {
                // ä½¿ç”¨ plus.io çš„æ–‡ä»¶ç³»ç»Ÿ API æ¥æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
                // ç›´æ¥è°ƒç”¨ç³»ç»Ÿçš„æ–‡ä»¶é€‰æ‹©å™¨
                var Intent = plus.android.importClass('android.content.Intent');
                var intent = new Intent(Intent.ACTION_GET_CONTENT);
                intent.setType('*/*'); // å…è®¸é€‰æ‹©æ‰€æœ‰æ–‡ä»¶ç±»å‹
                intent.addCategory(Intent.CATEGORY_OPENABLE);
                
                var Activity = plus.android.importClass('android.app.Activity');
                var main = plus.android.runtimeMainActivity();
                
                // é‡å†™ onActivityResult æ–¹æ³•
                main.onActivityResult = function(requestCode, resultCode, data) {
                    if (requestCode === 1001 && resultCode === Activity.RESULT_OK && data) {
                        var uri = data.getData();
                        if (uri) {
                            try {
                                // ç›´æ¥ä½¿ç”¨ ContentResolver è¯»å–æ–‡ä»¶å†…å®¹
                                var contentResolver = main.getContentResolver();
                                var inputStream = contentResolver.openInputStream(uri);
                                
                                // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
                                var fileName = 'temp_' + Date.now() + '.apk';
                                var cacheDir = main.getCacheDir();
                                var tempFile = plus.android.newObject('java.io.File', cacheDir, fileName);
                                var fileOutputStream = plus.android.newObject('java.io.FileOutputStream', tempFile);
                                
                                // å¤åˆ¶æ–‡ä»¶å†…å®¹
                                var buffer = plus.android.newObject('byte[]', 4096);
                                var len;
                                while ((len = inputStream.read(buffer)) > 0) {
                                    fileOutputStream.write(buffer, 0, len);
                                }
                                
                                // å…³é—­æµ
                                inputStream.close();
                                fileOutputStream.close();
                                
                                // è·å–ä¸´æ—¶æ–‡ä»¶è·¯å¾„
                                var tempPath = tempFile.getAbsolutePath();
                                
                                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦ä¸º APK
                                if (!tempPath.toLowerCase().endsWith('.apk')) {
                                    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                                    tempFile.delete();
                                    showToast('è¯·é€‰æ‹© APK æ–‡ä»¶');
                                    return;
                                }
                                
                                // è¯»å–æ–‡ä»¶
                                plus.io.resolveLocalFileSystemURL('file://' + tempPath, function(entry) {
                                    entry.file(function(file) {
                                        // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶ï¼Œä¸ç°æœ‰çš„ä¸Šä¼ é€»è¾‘ä¿æŒä¸€è‡´
                                        handleApkFile(file);
                                    }, function(e) {
                                        showToast('è¯»å–æ–‡ä»¶å¤±è´¥: ' + e.message);
                                        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                                        tempFile.delete();
                                    });
                                }, function(e) {
                                    showToast('è§£ææ–‡ä»¶è·¯å¾„å¤±è´¥: ' + e.message);
                                    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                                    tempFile.delete();
                                });
                            } catch (e) {
                                console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', e);
                                showToast('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + e.message);
                            }
                        }
                    }
                };
                
                // å¯åŠ¨æ–‡ä»¶é€‰æ‹©å™¨
                main.startActivityForResult(intent, 1001);
            } catch (e) {
                console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', e);
                showToast('æ–‡ä»¶é€‰æ‹©åŠŸèƒ½æš‚ä¸å¯ç”¨');
            }
        }

        // ç»Ÿä¸€å¤„ç† APK æ–‡ä»¶çš„å‡½æ•°
        function handleApkFile(file) {
            const tip = document.getElementById('status-tip');
            tip.style.display = 'block';
            tip.innerText = 'è§£æä¸­...';

            try {
                const parser = new AppInfoParser(file);
                parser.parse().then(async (info) => {
                    // 1. å¤„ç†åç§°
                    let finalName = info.name;
                    
                    // ä¼˜å…ˆå¯»æ‰¾ä¸­æ–‡åç§°
                    if (info.application && info.application.label) {
                        if (Array.isArray(info.application.label)) {
                            // éå†æ•°ç»„ï¼Œå¯»æ‰¾åŒ…å«ä¸­æ–‡å­—ç¬¦çš„åç§°
                            for (let label of info.application.label) {
                                if (/[\u4e00-\u9fa5]/.test(label)) {
                                    finalName = label;
                                    break;
                                }
                            }
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸­æ–‡åç§°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªåç§°
                            if (!finalName) {
                                finalName = info.application.label[0];
                            }
                        } else {
                            finalName = info.application.label;
                        }
                    }
                    
                    if (!finalName || String(finalName).startsWith('@')) finalName = info.package;

                    // 2. å¤„ç† SDK
                    const rawSdk = findMinSdk(info);
                    const androidVer = SDK_MAP[rawSdk] || "æœªçŸ¥";

                    // 3. å¤„ç†æ¶æ„
                    const zip = await JSZip.loadAsync(file);
                    const archs = new Set();
                    Object.keys(zip.files).forEach(p => { if (p.startsWith('lib/')) { const parts = p.split('/'); if (parts.length > 2) archs.add(parts[1]); } });
                    const archArray = Array.from(archs);
                    let bitDisplay = "å…¨æ¶æ„å…¼å®¹";
                    if (archArray.length > 0) {
                        const is64 = archArray.some(a => a.includes('64'));
                        const is32 = archArray.some(a => a.includes('v7a') || a === 'armeabi');
                        bitDisplay = (is64 && is32) ? "32/64ä½å…¼å®¹" : (is64 ? "çº¯64ä½" : "çº¯32ä½");
                    }

                    // 4. æ¸²æŸ“åŸºæœ¬ä¿¡æ¯
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('app-icon').src = info.icon || '';
                    document.getElementById('app-name').value = finalName;
                    document.getElementById('app-pkg').innerText = info.package;
                    document.getElementById('v-text').innerText = info.versionName;
                    document.getElementById('s-text').innerText = sizeMB + " MB";
                    document.getElementById('sdk-text').innerText = "Android " + androidVer + "+";
                    document.getElementById('arch-text').innerText = bitDisplay;

                    // 5. å¤„ç†APKä¸Šä¼ ï¼ˆå°äº100MBï¼‰
                    let appLink = '';
                    if (parseFloat(sizeMB) <= 100) {
                        // ä¸Šä¼ APKåˆ°å¯¹è±¡å­˜å‚¨
                        uploadApk(file).then((url) => {
                            appLink = url;
                            // 6. ä¸Šä¼ å›¾æ ‡åˆ°å¯¹è±¡å­˜å‚¨
                            if (info.icon) {
                                uploadIcon(info.icon);
                            }

                            // æ ¸å¿ƒé€»è¾‘ï¼šéšè—ä¸Šä¼ æ¡†ï¼Œæ˜¾ç¤ºè¡¨å•
                            document.getElementById('upload-zone').style.display = 'none';
                            document.getElementById('backup-upload').style.display = 'none';
                            tip.style.display = 'none';
                            document.getElementById('content-step').style.display = 'block';
                            apkInfo = { 
                                finalName, 
                                sizeMB, 
                                package: info.package, 
                                versionName: info.versionName, 
                                androidVer, 
                                bitDisplay, 
                                appLink 
                            };
                        }).catch((error) => {
                            tip.innerText = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                            console.error('ä¸Šä¼ é”™è¯¯:', error);
                        });
                    } else {
                        // å¤§äº100MBï¼Œæ˜¾ç¤ºç½‘ç›˜é“¾æ¥è¾“å…¥
                        document.getElementById('pan-section').style.display = 'block';

                        // 6. ä¸Šä¼ å›¾æ ‡åˆ°å¯¹è±¡å­˜å‚¨
                        if (info.icon) {
                            uploadIcon(info.icon);
                        }

                        // æ ¸å¿ƒé€»è¾‘ï¼šéšè—ä¸Šä¼ æ¡†ï¼Œæ˜¾ç¤ºè¡¨å•
                        document.getElementById('upload-zone').style.display = 'none';
                        document.getElementById('backup-upload').style.display = 'none';
                        tip.style.display = 'none';
                        document.getElementById('content-step').style.display = 'block';
                        apkInfo = { 
                            finalName, 
                            sizeMB, 
                            package: info.package, 
                            versionName: info.versionName, 
                            androidVer, 
                            bitDisplay, 
                            appLink 
                        };
                    }
                }).catch((err) => {
                    tip.innerText = "è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå";
                    console.error('è§£æé”™è¯¯:', err);
                });
            } catch (err) {
                tip.innerText = "è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå";
                console.error('è§£æé”™è¯¯:', err);
            }
        }

        function closeSelf() {
            if (window.plus) {
                plus.webview.currentWebview().close('auto');
            } else {
                window.history.back();
            }
        }

        document.addEventListener('plusready', function() {
            var webview = plus.webview.currentWebview();

            plus.key.addEventListener('backbutton', function() {
                webview.canBack(function(e) {
                    if (e.canBack) {
                        webview.back();
                    } else {
                        var path = window.location.pathname;
                        // è¿™é‡Œè¯†åˆ«ä¸ºéé¦–é¡µï¼Œæ‰§è¡Œå…³é—­é€»è¾‘
                        var isHomePage = path.indexOf('index.html') !== -1 && path.indexOf('app/') === -1;

                        if (isHomePage) {
                            plus.nativeUI.confirm("ç¡®å®šé€€å‡ºåº”ç”¨å—ï¼Ÿ", function(res) {
                                if (res.index === 0) plus.runtime.quit();
                            }, "æç¤º", ["ç¡®å®š", "å–æ¶ˆ"]);
                        } else {
                            // å­é¡µé¢ï¼šç›´æ¥å…³é—­ï¼Œè¿”å›é¦–é¡µ
                            if (plus.webview.all().length > 1) {
                                webview.close('auto'); 
                            } else {
                                history.back();
                            }
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
